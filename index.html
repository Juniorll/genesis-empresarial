<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>G√™nesis Empresarial - Atividade Online</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .transition-all { transition: all 0.3s ease-in-out; }
        .modal-bg { background-color: rgba(0,0,0,0.5); }
        .prose-custom { max-width: 80ch; }
        .prose-custom h1, .prose-custom h2, .prose-custom h3 { font-weight: 700; margin-top: 1.5em; margin-bottom: 0.5em;}
        .prose-custom p { margin-bottom: 1em; line-height: 1.6; }
        .prose-custom ul { list-style-position: inside; margin-left: 1.5em; margin-bottom: 1em; }
        .prose-custom li { margin-bottom: 0.5em; }
        .fade-enter-active, .fade-leave-active { transition: opacity 0.5s; }
        .fade-enter-from, .fade-leave-to { opacity: 0; }
        .slide-fade-enter-active { transition: all 0.3s ease-out; }
        .slide-fade-leave-active { transition: all 0.3s cubic-bezier(1, 0.5, 0.8, 1); }
        .slide-fade-enter-from, .slide-fade-leave-to { transform: translateX(20px); opacity: 0; }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div id="app" class="max-w-7xl mx-auto p-4 sm:p-6 lg:p-8">
        
        <!-- Cabe√ßalho -->
        <header class="flex justify-between items-center mb-6 pb-4 border-b border-gray-300">
            <div>
                <h1 class="text-3xl font-bold text-gray-900">üöÄ G√™nesis Empresarial</h1>
                <p class="text-gray-600" v-if="teamName">Equipe: <span class="font-semibold">{{ teamName }}</span></p>
            </div>
            <div class="flex items-center space-x-4">
                <button @click="showScoreboard = true" class="bg-indigo-600 text-white font-semibold px-4 py-2 rounded-lg shadow hover:bg-indigo-700 transition-all">
                    üèÜ Placar
                </button>
                 <button @click="showProfessorModal = true" class="bg-gray-700 text-white font-semibold px-4 py-2 rounded-lg shadow hover:bg-gray-800 transition-all">
                    üßë‚Äçüè´
                </button>
            </div>
        </header>

        <!-- Alerta de Conex√£o -->
        <div v-if="!connected" class="bg-red-100 border-l-4 border-red-500 text-red-700 p-4 mb-6 rounded-lg" role="alert">
          <p class="font-bold">Erro de Conex√£o</p>
          <p>{{ connectionMessage }}</p>
        </div>
        
        <!-- Conte√∫do Principal -->
        <main>
            <!-- Tela de Carregamento / Login -->
            <transition name="fade">
                <div v-if="loading" class="text-center py-20">
                    <svg class="animate-spin h-10 w-10 text-indigo-600 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <p class="mt-4 text-lg font-semibold">{{ loadingMessage }}</p>
                </div>
            </transition>

            <!-- Conte√∫do da Atividade -->
            <transition name="fade">
                <div v-if="!loading && connected">
                    
                    <!-- ETAPA 0: NOME DA EQUIPE -->
                    <section v-if="currentStep === 0" class="bg-white p-8 rounded-xl shadow-lg">
                        <h2 class="text-2xl font-bold mb-4">Bem-vindos, Empreendedores!</h2>
                        <p class="mb-6 text-gray-600">Para come√ßar a jornada, sua equipe precisa de um nome. Escolham um nome que represente a vis√£o e a energia de voc√™s.</p>
                        <div class="flex flex-col sm:flex-row gap-4">
                            <input type="text" v-model="teamNameInput" @keyup.enter="setTeamName" placeholder="Digite o nome da sua equipe aqui" class="flex-grow p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                            <button @click="setTeamName" class="bg-indigo-600 text-white font-semibold px-6 py-3 rounded-lg shadow hover:bg-indigo-700 transition-all disabled:bg-indigo-300" :disabled="!teamNameInput.trim()">Criar Equipe</button>
                        </div>
                    </section>

                    <!-- ETAPA 1: TESTE DE PERFIL -->
                    <section v-if="currentStep === 1" class="bg-white p-8 rounded-xl shadow-lg">
                        <h2 class="text-2xl font-bold mb-2">Etapa 1: Quem √© voc√™ no mundo dos neg√≥cios?</h2>
                        <p class="mb-6 text-gray-600">Responda √†s perguntas abaixo para descobrir seu perfil profissional. Seja honesto! N√£o h√° respostas certas ou erradas.</p>
                        <div v-if="!profile" class="space-y-6">
                            <div v-for="(question, qIndex) in questions" :key="qIndex" class="p-4 border border-gray-200 rounded-lg">
                                <p class="font-semibold mb-3">{{ qIndex + 1 }}. {{ question.text }}</p>
                                <div class="space-y-2">
                                    <label v-for="(option, oIndex) in question.options" :key="oIndex" class="flex items-center p-3 rounded-lg hover:bg-gray-50 cursor-pointer">
                                        <input type="radio" :name="'question-' + qIndex" :value="option.type" v-model="answers[qIndex]" class="h-4 w-4 text-indigo-600 border-gray-300 focus:ring-indigo-500">
                                        <span class="ml-3 text-gray-700">{{ option.text }}</span>
                                    </label>
                                </div>
                            </div>
                            <button @click="calculateProfile" class="w-full bg-indigo-600 text-white font-semibold px-6 py-3 rounded-lg shadow hover:bg-indigo-700 transition-all disabled:bg-indigo-300" :disabled="answers.includes(null)">Revelar meu Perfil</button>
                        </div>
                        <div v-else class="text-center bg-indigo-50 p-8 rounded-lg">
                             <h3 class="text-2xl font-bold text-indigo-800">{{ profile.name }}</h3>
                             <p class="text-indigo-600 font-semibold mt-1">{{ profile.title }}</p>
                             <p class="mt-4 text-left">{{ profile.description }}</p>
                             <p class="mt-4 font-semibold text-left">Lembre-se: Este √© um ponto de partida. Grandes profissionais combinam caracter√≠sticas de m√∫ltiplos perfis!</p>
                             <button @click="confirmProfile" class="mt-6 bg-green-600 text-white font-semibold px-8 py-3 rounded-lg shadow hover:bg-green-700 transition-all">Entendido! Pr√≥xima Etapa</button>
                        </div>
                    </section>
                    
                    <!-- ETAPA 2: ESCOLHA DA EMPRESA -->
                    <section v-if="currentStep === 2" class="bg-white p-8 rounded-xl shadow-lg">
                        <h2 class="text-2xl font-bold mb-2">Etapa 2: A Grande Decis√£o</h2>
                        <p class="mb-2 text-gray-600">Sua equipe agora tem uma miss√£o: escolher uma das tr√™s oportunidades de neg√≥cio abaixo. Leiam com aten√ß√£o, discutam e considerem os perfis de todos os membros da equipe.</p>
                        <p class="mb-6 text-gray-500 text-sm">A escolha certa pode impulsionar o sucesso de voc√™s desde o primeiro dia.</p>
                        <div class="grid md:grid-cols-3 gap-6">
                            <div v-for="company in companies" :key="company.id" 
                                 class="border-2 rounded-xl p-6 flex flex-col transition-all cursor-pointer"
                                 :class="selectedCompany === company.id ? 'border-indigo-600 ring-2 ring-indigo-300' : 'border-gray-200 hover:border-indigo-400'"
                                 @click="selectedCompany = company.id">
                                <h3 class="text-xl font-bold text-gray-900">{{ company.name }}</h3>
                                <p class="text-indigo-600 font-semibold text-sm mb-3">{{ company.slogan }}</p>
                                <p class="text-gray-600 flex-grow">{{ company.description }}</p>
                            </div>
                        </div>
                         <button @click="confirmCompanyChoice" class="mt-8 w-full bg-indigo-600 text-white font-semibold px-6 py-3 rounded-lg shadow hover:bg-indigo-700 transition-all disabled:bg-indigo-300" :disabled="!selectedCompany">Confirmar Escolha da Empresa</button>
                    </section>

                    <!-- ETAPA 3: DEFINI√á√ÉO DE CARGOS -->
                    <section v-if="currentStep === 3" class="bg-white p-8 rounded-xl shadow-lg">
                        <h2 class="text-2xl font-bold mb-2">Etapa 3: Organizando a Lideran√ßa</h2>
                        <p class="mb-6 text-gray-600">Toda grande empresa precisa de uma estrutura. Com base nos perfis e habilidades, decidam quem ocupar√° os cargos de lideran√ßa iniciais (C-Level). Cada membro da equipe deve assumir um dos cargos abaixo.</p>
                        <div class="space-y-4">
                            <div v-for="role in roles" :key="role.id" class="bg-gray-50 p-4 rounded-lg">
                                <h3 class="font-bold">{{ role.name }} ({{ role.id }})</h3>
                                <p class="text-sm text-gray-600 mb-2">{{ role.description }}</p>
                                <select v-model="assignedRoles[role.id]" class="w-full p-2 border border-gray-300 rounded-lg">
                                    <option :value="null" disabled>Selecione um membro da equipe</option>
                                    <option v-for="member in teamMembers" :key="member.id" :value="member.id" :disabled="isMemberAssigned(member.id) && assignedRoles[role.id] !== member.id">
                                        {{ member.name }} ({{ member.profile }})
                                    </option>
                                </select>
                            </div>
                        </div>
                        <button @click="confirmRoles" class="mt-8 w-full bg-indigo-600 text-white font-semibold px-6 py-3 rounded-lg shadow hover:bg-indigo-700 transition-all disabled:bg-indigo-300" :disabled="!areAllRolesAssigned()">Confirmar Cargos</button>
                    </section>

                    <!-- ETAPA 4: CONTRATA√á√ÉO E ORGANOGRAMA -->
                    <section v-if="currentStep === 4" class="bg-white p-8 rounded-xl shadow-lg">
                        <h2 class="text-2xl font-bold mb-2">Etapa 4: Expans√£o da Equipe</h2>
                        <p class="mb-4 text-gray-600">Sua lideran√ßa est√° formada, mas para crescer, voc√™s precisam de mais talentos. Sua equipe recebeu <strong class="text-indigo-600">{{ resourcePoints }} Pontos de Recurso (PR)</strong> para as primeiras contrata√ß√µes.</p>
                        
                        <div class="bg-amber-50 border-l-4 border-amber-400 p-4 rounded-r-lg mb-6">
                            <h3 class="font-bold text-amber-800">An√°lise de Mercado para: {{ getSelectedCompanyName() }}</h3>
                            <p class="text-amber-700 text-sm">{{ getCompanyMarketInfo() }}</p>
                        </div>

                        <div class="grid md:grid-cols-2 gap-6">
                            <div v-for="hire in availableHires" :key="hire.role" class="bg-gray-50 p-4 rounded-lg border">
                                <h4 class="font-bold">{{ hire.role }}</h4>
                                <p class="text-sm text-gray-600 mb-2">{{ hire.description }}</p>
                                <p class="text-sm font-semibold mb-3">Custo: <span class="text-indigo-600">{{ hire.cost }} PR</span></p>
                                <div class="flex items-center justify-end space-x-4">
                                    <button @click="adjustHireCount(hire, -1)" class="bg-gray-200 h-8 w-8 rounded-full font-bold text-lg flex items-center justify-center">-</button>
                                    <span class="font-bold text-xl w-8 text-center">{{ getHireCount(hire.role) }}</span>
                                    <button @click="adjustHireCount(hire, 1)" class="bg-gray-200 h-8 w-8 rounded-full font-bold text-lg flex items-center justify-center">+</button>
                                </div>
                            </div>
                        </div>

                        <div class="mt-8 pt-4 border-t">
                            <p class="text-xl font-bold text-right">PR Restantes: <span class="text-indigo-600">{{ remainingPoints }}</span></p>
                             <p v-if="remainingPoints < 0" class="text-red-500 text-right font-semibold">Voc√™ gastou mais recursos do que possu√≠a!</p>
                            <button @click="confirmHires" class="mt-4 w-full bg-indigo-600 text-white font-semibold px-6 py-3 rounded-lg shadow hover:bg-indigo-700 transition-all disabled:bg-indigo-300" :disabled="remainingPoints < 0">Finalizar Contrata√ß√µes e Gerar Organograma</button>
                        </div>
                    </section>

                    <!-- ETAPA 5: ORGANOGRAMA FINAL -->
                    <section v-if="currentStep === 5" class="bg-white p-8 rounded-xl shadow-lg">
                         <h2 class="text-2xl font-bold mb-4 text-center">Estrutura da {{ teamName }}</h2>
                         <div id="organogram-container" class="bg-gray-50 p-6 rounded-lg border border-gray-200 overflow-x-auto">
                            <div class="text-center mb-8">
                                <div class="inline-block bg-indigo-600 text-white p-4 rounded-lg shadow-lg">
                                    <p class="font-bold text-lg">{{ getRoleHolderName('CEO') }}</p>
                                    <p class="text-sm">CEO (Diretor Executivo)</p>
                                </div>
                            </div>
                            <div class="flex justify-center items-start gap-4 md:gap-8">
                                <!-- Coluna do COO -->
                                <div class="text-center">
                                    <div class="inline-block bg-blue-500 text-white p-3 rounded-lg shadow">
                                        <p class="font-bold">{{ getRoleHolderName('COO') }}</p>
                                        <p class="text-xs">COO (Diretor de Opera√ß√µes)</p>
                                    </div>
                                    <div v-if="hiredCounts['Gerente de Projetos'] > 0 || hiredCounts['Analista de Qualidade'] > 0" class="mt-4 space-y-3">
                                        <div v-if="hiredCounts['Gerente de Projetos'] > 0" class="inline-block bg-gray-200 p-2 rounded-lg text-sm">Gerente de Projetos ({{ hiredCounts['Gerente de Projetos'] }})</div>
                                        <div v-if="hiredCounts['Analista de Qualidade'] > 0" class="inline-block bg-gray-200 p-2 rounded-lg text-sm">Analista de Qualidade ({{ hiredCounts['Analista de Qualidade'] }})</div>
                                    </div>
                                </div>
                                <!-- Coluna do CTO -->
                                <div class="text-center">
                                    <div class="inline-block bg-teal-500 text-white p-3 rounded-lg shadow">
                                        <p class="font-bold">{{ getRoleHolderName('CTO') }}</p>
                                        <p class="text-xs">CTO (Diretor de Tecnologia)</p>
                                    </div>
                                     <div v-if="hiredCounts['Desenvolvedor S√™nior'] > 0 || hiredCounts['Desenvolvedor J√∫nior'] > 0" class="mt-4 space-y-3">
                                        <div v-if="hiredCounts['Desenvolvedor S√™nior'] > 0" class="inline-block bg-gray-200 p-2 rounded-lg text-sm">Dev S√™nior ({{ hiredCounts['Desenvolvedor S√™nior'] }})</div>
                                        <div v-if="hiredCounts['Desenvolvedor J√∫nior'] > 0" class="inline-block bg-gray-200 p-2 rounded-lg text-sm">Dev J√∫nior ({{ hiredCounts['Desenvolvedor J√∫nior'] }})</div>
                                    </div>
                                </div>
                            </div>
                         </div>
                         <button @click="downloadOrganogram" class="mt-8 w-full bg-green-600 text-white font-semibold px-6 py-3 rounded-lg shadow hover:bg-green-700 transition-all">Baixar Organograma (.png)</button>
                         <p class="text-center mt-6 text-lg font-semibold">Parab√©ns! A primeira fase da sua empresa est√° completa. Aguarde as instru√ß√µes do professor.</p>
                    </section>

                </div>
            </transition>
        </main>
        
        <!-- Modal do Placar -->
        <transition name="fade">
            <div v-if="showScoreboard" class="fixed inset-0 z-10 flex items-center justify-center modal-bg" @click="showScoreboard = false">
                <div class="bg-white rounded-xl shadow-2xl p-8 w-full max-w-2xl" @click.stop>
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-bold">üèÜ Placar em Tempo Real</h2>
                        <button @click="showScoreboard = false" class="text-gray-500 hover:text-gray-800">&times;</button>
                    </div>
                    <div class="space-y-4">
                        <div v-for="team in sortedTeams" :key="team.id" class="flex items-center justify-between p-4 rounded-lg" :class="team.id === teamId ? 'bg-indigo-100' : 'bg-gray-100'">
                            <span class="font-bold text-lg">{{ team.name }}</span>
                            <span class="font-bold text-xl text-indigo-600">{{ scoresVisible ? team.score : '???' }}</span>
                        </div>
                        <div v-if="!scoresVisible" class="text-center text-gray-500 pt-4">
                            As pontua√ß√µes ser√£o reveladas pelo professor...
                        </div>
                    </div>
                </div>
            </div>
        </transition>

         <!-- Modal do Professor -->
        <transition name="fade">
            <div v-if="showProfessorModal" class="fixed inset-0 z-20 flex items-center justify-center modal-bg" @click="showProfessorModal = false">
                <div class="bg-white rounded-xl shadow-2xl p-8 w-full max-w-sm" @click.stop>
                     <h2 class="text-2xl font-bold text-center mb-4">Modo Professor</h2>
                    <div v-if="!isProfessor">
                        <label for="prof-pass" class="block font-semibold mb-2">Senha:</label>
                        <input type="password" id="prof-pass" v-model="professorPassword" @keyup.enter="enterProfessorMode" class="w-full p-2 border border-gray-300 rounded-lg mb-4">
                        <button @click="enterProfessorMode" class="w-full bg-gray-700 text-white font-semibold py-2 rounded-lg hover:bg-gray-800">Entrar</button>
                    </div>
                    <div v-else class="text-center space-y-4">
                        <p class="text-green-600 font-semibold">Autenticado com sucesso!</p>
                        <button @click="toggleScoresVisibility" class="w-full bg-indigo-600 text-white font-semibold py-2 rounded-lg hover:bg-indigo-700">
                            {{ scoresVisible ? 'Ocultar Pontua√ß√µes' : 'Revelar Pontua√ß√µes' }}
                        </button>
                        <button @click="logoutProfessor" class="w-full text-sm text-gray-600 hover:underline">Sair do Modo Professor</button>
                    </div>
                </div>
            </div>
        </transition>

    </div>

    <!-- Firebase -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection, onSnapshot, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- FIREBASE CONFIG (WILL BE PROVIDED BY THE ENVIRONMENT) ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'genesis-empresarial-dev';
        const firebaseConfig = {
          apiKey: "AIzaSyDFx4jZDjnsEmOSFUXW3NykN0hPSTBL7Lc",
          authDomain: "genesis-empresarial-87b1d.firebaseapp.com",
          projectId: "genesis-empresarial-87b1d",
          storageBucket: "genesis-empresarial-87b1d.firebasestorage.app",
          messagingSenderId: "41214218923",
          appId: "1:41214218923:web:4b77d3930b61f423dbddee",
          measurementId: "G-S68YFP7JHC"
        };
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // --- FIREBASE INITIALIZATION ---
        let app, auth, db;
        
        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
        } catch (e) {
            console.error("Firebase initialization failed:", e);
            // Handle initialization error in the UI if needed
        }


        const { createApp, ref, reactive, computed, onMounted, watch } = Vue

        createApp({
            setup() {
                // Estado da Aplica√ß√£o
                const loading = ref(true);
                const loadingMessage = ref('Conectando ao servidor...');
                const connected = ref(false);
                const connectionMessage = ref('');
                const currentStep = ref(0);
                const userId = ref(null);
                const teamId = ref(null); // teamName em hash ou ID unico
                const teamName = ref('');
                const teamNameInput = ref('');

                // Dados da Atividade
                const questions = reactive([
                    { text: "Diante de um grande projeto novo, sua primeira rea√ß√£o √©:", options: [{text: "Planejar cada detalhe antes de come√ßar.", type: "Analista"},{text: "Juntar a equipe para um brainstorming de ideias malucas.", type: "Inovador"},{text: "Come√ßar a construir um prot√≥tipo imediatamente.", type: "Executor"},{text: "Conversar com as pessoas para entender o que elas precisam.", type: "Comunicador"}]},
                    { text: "Qual ambiente de trabalho te deixa mais produtivo?", options: [{text: "Um lugar quieto, com dados e gr√°ficos para analisar.", type: "Analista"},{text: "Uma sala cheia de quadros brancos, post-its e liberdade para criar.", type: "Inovador"},{text: "Qualquer lugar onde eu possa colocar a m√£o na massa e ver resultados.", type: "Executor"},{text: "Um ambiente colaborativo, cheio de reuni√µes e conversas.", type: "Comunicador"}]},
                    { text: "Um cliente reporta um problema inesperado. O que voc√™ faz?", options: [{text: "Investigo a causa raiz do problema sistematicamente.", type: "Analista"},{text: "Penso em tr√™s solu√ß√µes completamente novas para resolver e encantar.", type: "Inovador"},{text: "Aplico uma corre√ß√£o r√°pida para resolver o agora, e depois melhoro.", type: "Executor"},{text: "Ligo para o cliente, ou√ßo com aten√ß√£o e garanto que ele se sinta compreendido.", type: "Comunicador"}]},
                    { text: "Como voc√™ prefere aprender algo novo?", options: [{text: "Lendo a documenta√ß√£o completa e fazendo anota√ß√µes.", type: "Analista"},{text: "Assistindo a v√≠deos inspiradores e experimentando sem medo de errar.", type: "Inovador"},{text: "Seguindo um tutorial pr√°tico, passo a passo.", type: "Executor"},{text: "Participando de um workshop em grupo e discutindo com colegas.", type: "Comunicador"}]},
                    { text: "O que √© mais importante para o sucesso de uma empresa?", options: [{text: "Processos eficientes e decis√µes baseadas em dados.", type: "Analista"},{text: "Uma vis√£o de futuro ousada e capacidade de se reinventar.", type: "Inovador"},{text: "Entregar resultados de forma r√°pida e consistente.", type: "Executor"},{text: "Uma cultura forte e um bom relacionamento com clientes e equipe.", type: "Comunicador"}]}
                ]);
                const answers = ref(Array(questions.length).fill(null));
                const profile = ref(null);
                const profiles = {
                    Analista: { name: "O Arquiteto Analista", title: "A Mente Estrat√©gica", description: "Voc√™ √© met√≥dico, detalhista e brilha ao analisar dados para tomar decis√µes bem-fundamentadas. Sua for√ßa est√° em criar sistemas l√≥gicos, encontrar falhas e garantir a qualidade e a estabilidade. Processos e planejamento s√£o seus melhores amigos." },
                    Inovador: { name: "O Vision√°rio Inovador", title: "A For√ßa Criativa", description: "Voc√™ enxerga al√©m do √≥bvio e adora criar solu√ß√µes disruptivas. Sua mente est√° sempre borbulhando com novas ideias e possibilidades. Voc√™ n√£o tem medo de arriscar e √© apaixonado por construir o futuro, mesmo que o caminho seja incerto." },
                    Executor: { name: "O Realizador Executor", title: "A Pot√™ncia da A√ß√£o", description: "Voc√™ √© pr√°tico, focado e tem uma habilidade incr√≠vel de transformar ideias em realidade. Enquanto outros discutem, voc√™ j√° est√° fazendo. Seu lema √© 'feito √© melhor que perfeito' e voc√™ se motiva ao ver o progresso e entregar resultados concretos." },
                    Comunicador: { name: "O Conector Comunicador", title: "A Alma do Neg√≥cio", description: "Voc√™ entende de pessoas. Sua grande for√ßa √© construir pontes, motivar a equipe, negociar com clientes e criar uma cultura positiva. Voc√™ sabe que a tecnologia s√≥ tem valor quando resolve problemas reais para pessoas reais." }
                };

                const companies = reactive([
                    { id: 'Fintech', name: 'Plataforma Fintech "ConectaBank"', slogan: 'Simplificando o futuro do dinheiro.', description: 'Uma plataforma para gest√£o de finan√ßas pessoais e investimentos para o p√∫blico jovem, com foco em usabilidade, seguran√ßa robusta e relat√≥rios anal√≠ticos precisos.'},
                    { id: 'Edtech', name: 'Game Educacional "Aventura do Saber"', slogan: 'Aprender nunca foi t√£o divertido.', description: 'Um jogo mobile de aventura com quizzes e desafios interativos, focado em engajar estudantes com uma experi√™ncia de aprendizado imersiva e criativa.'},
                    { id: 'Logtech', name: 'App de Log√≠stica "Entrega √Ågil"', slogan: 'Sua entrega, no tempo certo.', description: 'Um aplicativo para otimizar rotas de entrega para pequenas e m√©dias empresas, com foco em velocidade de implementa√ß√£o, efici√™ncia e resultados r√°pidos e mensur√°veis.'}
                ]);
                const selectedCompany = ref(null);

                const roles = reactive([
                    {id: 'CEO', name: 'Chief Executive Officer', description: 'O l√≠der principal. Define a vis√£o e a estrat√©gia geral da empresa, sendo o rosto da organiza√ß√£o.'},
                    {id: 'CTO', name: 'Chief Technology Officer', description: 'O l√≠der da tecnologia. Supervisiona o desenvolvimento, a infraestrutura e a inova√ß√£o tecnol√≥gica do produto.'},
                    {id: 'COO', name: 'Chief Operating Officer', description: 'O l√≠der das opera√ß√µes. Garante que os processos do dia a dia da empresa funcionem de forma eficiente e produtiva.'}
                ]);
                const assignedRoles = ref({ CEO: null, CTO: null, COO: null });
                const teamMembers = ref([]);

                const resourcePoints = ref(100);
                const availableHires = reactive([
                    { role: 'Desenvolvedor S√™nior', description: 'Acelera o desenvolvimento de funcionalidades complexas.', cost: 40 },
                    { role: 'Desenvolvedor J√∫nior', description: 'D√° suporte ao time de tecnologia e aprende r√°pido.', cost: 20 },
                    { role: 'Gerente de Projetos', description: 'Organiza as tarefas e garante os prazos.', cost: 30 },
                    { role: 'Analista de Qualidade', description: 'Testa o produto para encontrar bugs e garantir a qualidade.', cost: 25 },
                ]);
                const hiredCounts = ref({});

                // Estado do Placar e Professor
                const showScoreboard = ref(false);
                const allTeams = ref([]);
                const scoresVisible = ref(false);
                const showProfessorModal = ref(false);
                const isProfessor = ref(false);
                const professorPassword = ref('');
                
                // Propriedades Computadas
                const sortedTeams = computed(() => {
                    return [...allTeams.value].sort((a, b) => (b.score || 0) - (a.score || 0));
                });

                const remainingPoints = computed(() => {
                    return resourcePoints.value - Object.values(hiredCounts.value).reduce((total, hire) => total + (hire.count * hire.cost), 0);
                });

                // Fun√ß√µes e M√©todos
                const setupFirebase = () => {
                    if (!auth || !db) {
                        loadingMessage.ref = 'Falha na inicializa√ß√£o do Firebase.';
                        connected.ref = false;
                        return;
                    }

                    loadingMessage.value = 'Autenticando...';
                    onAuthStateChanged(auth, async user => {
                        if (user) {
                            userId.value = user.uid;
                            connected.value = true;
                            await loadGameState();
                            setupListeners();
                        } else {
                            try {
                                await signInAnonymously(auth);
                            } catch (error) {
                                console.error("Anonymous sign-in failed:", error);
                                loadingMessage.value = 'Falha na autentica√ß√£o. Recarregue a p√°gina.';
                                connected.value = false;
                            }
                        }
                    });
                };
                
                const loadGameState = async () => {
                    const localData = JSON.parse(localStorage.getItem(`genesis-empresarial-${userId.value}`));
                    if (localData && localData.teamId) {
                        teamId.value = localData.teamId;
                        teamName.value = localData.teamName;

                        const docRef = doc(db, "apps", appId, "teams", teamId.value);
                        const docSnap = await getDoc(docRef);

                        if (docSnap.exists()) {
                            const data = docSnap.data();
                            currentStep.value = data.currentStep || 0;
                            selectedCompany.value = data.selectedCompany || null;
                            assignedRoles.value = data.assignedRoles || { CEO: null, CTO: null, COO: null };
                            teamMembers.value = data.members || [];
                            hiredCounts.value = data.hiredCounts || {};
                            // Find current user's profile
                            const currentUserData = teamMembers.value.find(m => m.id === userId.value);
                            if (currentUserData && currentUserData.profile) {
                                profile.value = profiles[currentUserData.profile];
                            }
                        } else {
                            // Discrepancy, reset local state
                            resetLocalState();
                        }
                    }
                    loading.value = false;
                };

                const resetLocalState = () => {
                    localStorage.removeItem(`genesis-empresarial-${userId.value}`);
                    teamId.value = null;
                    teamName.value = '';
                    currentStep.value = 0;
                }

                const setupListeners = () => {
                    const teamsCollection = collection(db, "apps", appId, "teams");
                    onSnapshot(teamsCollection, (snapshot) => {
                        allTeams.value = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    });

                    const gameControllerDoc = doc(db, "apps", appId, "controller", "game_state");
                    onSnapshot(gameControllerDoc, (doc) => {
                        if (doc.exists()) {
                            scoresVisible.value = doc.data().scoresVisible || false;
                        }
                    });
                };

                const saveState = async (dataToSave) => {
                    if (!teamId.value) return;
                    try {
                        const docRef = doc(db, "apps", appId, "teams", teamId.value);
                        await setDoc(docRef, dataToSave, { merge: true });
                    } catch (error) {
                        console.error("Error saving state:", error);
                    }
                };

                const setTeamName = async () => {
                    const name = teamNameInput.value.trim();
                    if (!name) return;
                    teamName.value = name;
                    teamId.value = name.toLowerCase().replace(/\s+/g, '-');
                    
                    localStorage.setItem(`genesis-empresarial-${userId.value}`, JSON.stringify({ teamId: teamId.value, teamName: teamName.value }));

                    await saveState({
                        name: teamName.value,
                        score: 0,
                        currentStep: 1,
                        members: [{ id: userId.value, name: `Membro ${Math.floor(Math.random() * 1000)}` }] // Placeholder name
                    });
                    
                    // Add a way for user to set their name later if needed
                    teamMembers.value = [{ id: userId.value, name: `Membro ${Math.floor(Math.random() * 1000)}` }];
                    currentStep.value = 1;
                };

                const calculateProfile = () => {
                    const counts = answers.value.reduce((acc, curr) => {
                        acc[curr] = (acc[curr] || 0) + 1;
                        return acc;
                    }, {});
                    const result = Object.keys(counts).reduce((a, b) => counts[a] > counts[b] ? a : b);
                    profile.value = profiles[result];
                };

                const confirmProfile = async () => {
                    const memberIndex = teamMembers.value.findIndex(m => m.id === userId.value);
                    const profileName = Object.keys(profiles).find(key => profiles[key].name === profile.value.name);
                    
                    if (memberIndex !== -1) {
                        teamMembers.value[memberIndex].profile = profileName;
                         // Prompt for user's actual name
                        const name = prompt("√ìtimo! Agora, por favor, digite seu nome:", teamMembers.value[memberIndex].name);
                        teamMembers.value[memberIndex].name = name || teamMembers.value[memberIndex].name;
                    }
                    
                    await saveState({ members: teamMembers.value, currentStep: 2 });
                    currentStep.value = 2;
                };

                const calculatePoints = () => {
                    let totalScore = 0;
                    // Pontos da Empresa
                    const companyProfiles = {
                        'Fintech': ['Analista', 'Analista', 'Executor'],
                        'Edtech': ['Inovador', 'Inovador', 'Comunicador'],
                        'Logtech': ['Executor', 'Executor', 'Analista']
                    };
                    const teamProfiles = teamMembers.value.map(m => m.profile);
                    const targetProfiles = companyProfiles[selectedCompany.value];
                    totalScore += teamProfiles.reduce((score, profile) => {
                        return targetProfiles.includes(profile) ? score + 15 : score + 5;
                    }, 0);

                    // Pontos dos Cargos
                    const roleAffinities = {
                        'CEO': { 'Comunicador': 20, 'Inovador': 15, 'Executor': 10, 'Analista': 5 },
                        'CTO': { 'Inovador': 20, 'Analista': 15, 'Executor': 10, 'Comunicador': 5 },
                        'COO': { 'Executor': 20, 'Analista': 15, 'Comunicador': 10, 'Inovador': 5 }
                    };
                    for (const roleId in assignedRoles.value) {
                        const memberId = assignedRoles.value[roleId];
                        const member = teamMembers.value.find(m => m.id === memberId);
                        if (member) {
                            totalScore += roleAffinities[roleId][member.profile] || 0;
                        }
                    }

                    // Pontos das Contrata√ß√µes
                    const hirePriorities = {
                       'Fintech': { 'Desenvolvedor S√™nior': 20, 'Analista de Qualidade': 15, 'Desenvolvedor J√∫nior': 10, 'Gerente de Projetos': 5 },
                       'Edtech': { 'Desenvolvedor S√™nior': 20, 'Desenvolvedor J√∫nior': 15, 'Gerente de Projetos': 10, 'Analista de Qualidade': 5 },
                       'Logtech': { 'Gerente de Projetos': 20, 'Desenvolvedor S√™nior': 15, 'Analista de Qualidade': 10, 'Desenvolvedor J√∫nior': 5 }
                    };
                    for(const hireRole in hiredCounts.value) {
                        const count = hiredCounts.value[hireRole].count;
                        if (count > 0) {
                            totalScore += (hirePriorities[selectedCompany.value][hireRole] || 0) * count;
                        }
                    }

                    return totalScore;
                };

                const confirmCompanyChoice = async () => {
                    await saveState({ selectedCompany: selectedCompany.value, currentStep: 3 });
                    currentStep.value = 3;
                };

                const isMemberAssigned = (memberId) => {
                    return Object.values(assignedRoles.value).includes(memberId);
                };

                const areAllRolesAssigned = () => {
                    const assignedValues = Object.values(assignedRoles.value);
                    const uniqueValues = new Set(assignedValues);
                    return assignedValues.every(v => v !== null) && uniqueValues.size === teamMembers.value.length && teamMembers.value.length >= 3;
                };
                
                const confirmRoles = async () => {
                    await saveState({ assignedRoles: assignedRoles.value, currentStep: 4 });
                    currentStep.value = 4;
                };

                const getSelectedCompanyName = () => companies.find(c => c.id === selectedCompany.value)?.name || 'sua empresa';

                const getCompanyMarketInfo = () => {
                    const infos = {
                        'Fintech': 'O mercado financeiro valoriza extrema seguran√ßa e precis√£o. Erros n√£o s√£o tolerados e a confian√ßa do cliente √© tudo. Uma base tecnol√≥gica s√≥lida √© essencial desde o in√≠cio.',
                        'Edtech': 'O setor de educa√ß√£o √© altamente competitivo em engajamento. Para se destacar, seu jogo precisa ser criativo, divertido e tecnicamente polido para cativar os alunos.',
                        'Logtech': 'Clientes de log√≠stica precisam de resultados r√°pidos e eficientes. A organiza√ß√£o do projeto e a capacidade de entregar uma solu√ß√£o funcional rapidamente s√£o cruciais para o sucesso inicial.'
                    };
                    return infos[selectedCompany.value] || '';
                }

                const getHireCount = (role) => hiredCounts.value[role]?.count || 0;

                const adjustHireCount = (hire, amount) => {
                    if (!hiredCounts.value[hire.role]) {
                        hiredCounts.value[hire.role] = { count: 0, cost: hire.cost };
                    }
                    const newCount = hiredCounts.value[hire.role].count + amount;
                    if (newCount >= 0) {
                        hiredCounts.value[hire.role].count = newCount;
                    }
                };

                const confirmHires = async () => {
                    const finalScore = calculatePoints();
                    await saveState({
                        hiredCounts: hiredCounts.value,
                        currentStep: 5,
                        score: finalScore
                    });
                    currentStep.value = 5;
                };
                
                const getRoleHolderName = (roleId) => {
                    const memberId = assignedRoles.value[roleId];
                    return teamMembers.value.find(m => m.id === memberId)?.name || 'N√£o definido';
                }

                const downloadOrganogram = () => {
                    const node = document.getElementById('organogram-container');
                     html2canvas(node, {
                        backgroundColor: '#ffffff',
                        scale: 2
                    }).then(canvas => {
                        const image = canvas.toDataURL("image/png").replace("image/png", "image/octet-stream");
                        const link = document.createElement('a');
                        link.download = `organograma-${teamName.value}.png`;
                        link.href = image;
                        link.click();
                    });
                };
                
                const enterProfessorMode = () => {
                    if (professorPassword.value === "mestre") {
                        isProfessor.value = true;
                        showProfessorModal.value = false;
                        professorPassword.value = '';
                    } else {
                        alert("Senha incorreta.");
                        professorPassword.value = '';
                    }
                };

                const logoutProfessor = () => {
                    isProfessor.value = false;
                }

                const toggleScoresVisibility = async () => {
                    try {
                        const docRef = doc(db, "apps", appId, "controller", "game_state");
                        await setDoc(docRef, { scoresVisible: !scoresVisible.value }, { merge: true });
                    } catch(error) {
                        console.error("Error toggling score visibility:", error);
                        alert("N√£o foi poss√≠vel alterar a visibilidade. Verifique a conex√£o.");
                    }
                };


                onMounted(() => {
                    setupFirebase();
                });

                return {
                    loading, loadingMessage, connected, connectionMessage, currentStep, teamName, teamNameInput,
                    questions, answers, profile, calculateProfile, confirmProfile,
                    companies, selectedCompany, confirmCompanyChoice,
                    roles, assignedRoles, teamMembers, isMemberAssigned, areAllRolesAssigned, confirmRoles,
                    resourcePoints, availableHires, hiredCounts, remainingPoints, getSelectedCompanyName, getCompanyMarketInfo, getHireCount, adjustHireCount, confirmHires,
                    getRoleHolderName, downloadOrganogram,
                    setTeamName,
                    showScoreboard, sortedTeams, teamId, scoresVisible,
                    showProfessorModal, isProfessor, professorPassword, enterProfessorMode, logoutProfessor, toggleScoresVisibility
                }
            }
        }).mount('#app')

    </script>
</body>
</html>

