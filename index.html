<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>G√™nesis Empresarial - ATO 1</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .transition-all { transition: all 0.3s ease-in-out; }
        .modal-bg { background-color: rgba(0,0,0,0.5); }
        .fade-enter-active, .fade-leave-active { transition: opacity 0.5s; }
        .fade-enter-from, .fade-leave-to { opacity: 0; }
        .join-code { letter-spacing: 0.25em; }
        .satisfaction-rating input[type="radio"]:checked+label {
            transform: scale(1.15);
            border-color: #4f46e5;
        }
        [v-cloak] { display: none; }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div id="app" class="max-w-7xl mx-auto p-4 sm:p-6 lg:p-8" v-cloak>
        
        <!-- Cabe√ßalho -->
        <header class="flex justify-between items-center mb-6 pb-4 border-b border-gray-300">
            <div>
                <h1 class="text-3xl font-bold text-gray-900">üöÄ G√™nesis Empresarial</h1>
                <p class="text-gray-600" v-if="teamName">Equipe: <span class="font-semibold">{{ teamName }}</span> <span v-if="isCEO" class="text-indigo-600 font-bold">(Voc√™ √© o CEO)</span></p>
            </div>
            <div class="flex items-center space-x-4">
                <button v-if="playerAuthenticated" @click="logout" title="Sair da sess√£o" class="bg-red-500 text-white font-semibold px-4 py-2 rounded-lg shadow hover:bg-red-600 transition-all">
                    Sair
                </button>
                <button @click="showScoreboard = true" class="bg-indigo-600 text-white font-semibold px-4 py-2 rounded-lg shadow hover:bg-indigo-700 transition-all">
                    üèÜ Placar
                </button>
                 <button @click="showProfessorModal = true" class="bg-gray-700 text-white font-semibold px-4 py-2 rounded-lg shadow hover:bg-gray-800 transition-all">
                    üßë‚Äçüè´
                </button>
            </div>
        </header>

        <!-- Conte√∫do Principal -->
        <main>
            <!-- Tela de Carregamento -->
            <transition name="fade">
                <div v-if="loading" class="text-center py-20">
                    <svg class="animate-spin h-10 w-10 text-indigo-600 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <p class="mt-4 text-lg font-semibold">{{ loadingMessage }}</p>
                </div>
            </transition>

            <!-- Conte√∫do da Atividade -->
            <transition name="fade">
                <div v-if="!loading">
                    
                    <!-- ETAPA 0.1: LOGIN DO JOGADOR -->
                     <section v-if="!playerAuthenticated" class="bg-white p-8 rounded-xl shadow-lg max-w-lg mx-auto">
                        <h2 class="text-2xl font-bold mb-4">Acesso √† Plataforma</h2>
                        <p class="mb-4 text-gray-600 text-sm">Crie seu login para come√ßar ou para continuar de onde parou. Use o mesmo nome e senha para voltar √† sua equipe.</p>
                        <input type="text" v-model="playerNameInput" placeholder="Seu nome" class="w-full p-3 mb-3 border border-gray-300 rounded-lg">
                        <input type="password" v-model="playerPasswordInput" placeholder="Sua senha" class="w-full p-3 mb-3 border border-gray-300 rounded-lg">
                        <button @click="accessPlatform" class="mt-3 w-full bg-indigo-600 text-white font-semibold px-6 py-3 rounded-lg shadow hover:bg-indigo-700 transition-all disabled:bg-indigo-300" :disabled="!playerNameInput.trim() || !playerPasswordInput.trim()">Acessar</button>
                    </section>

                    <!-- ETAPA 0.2: HUB DE EQUIPES -->
                    <section v-if="playerAuthenticated && !teamId" class="bg-white p-8 rounded-xl shadow-lg">
                         <h2 class="text-2xl font-bold mb-4">Bem-vindo(a), {{ playerNameInput }}!</h2>
                        <div class="grid md:grid-cols-2 gap-8">
                            <!-- Criar Equipe -->
                            <div>
                                <h3 class="text-xl font-semibold mb-3">Criar uma Nova Equipe</h3>
                                <p class="mb-4 text-gray-600 text-sm">Se voc√™ √© o primeiro do seu grupo, crie a equipe e compartilhe o c√≥digo com os outros.</p>
                                <input type="text" v-model="teamNameInput" placeholder="Nome da sua nova equipe" class="w-full p-3 border border-gray-300 rounded-lg">
                                <button @click="createTeam" class="mt-3 w-full bg-indigo-600 text-white font-semibold px-6 py-3 rounded-lg shadow hover:bg-indigo-700 transition-all disabled:bg-indigo-300" :disabled="!teamNameInput.trim()">Criar Equipe</button>
                            </div>
                             <!-- Entrar na Equipe -->
                            <div>
                                <h3 class="text-xl font-semibold mb-3">Entrar em uma Equipe</h3>
                                <p class="mb-4 text-gray-600 text-sm">Se sua equipe j√° foi criada, insira o c√≥digo fornecido pelo seu colega.</p>
                                <input type="text" v-model="joinCodeInput" placeholder="C√≥digo da Equipe" class="w-full p-3 mb-3 border border-gray-300 rounded-lg uppercase text-center font-mono text-lg">
                                <button @click="joinTeam" class="mt-3 w-full bg-gray-600 text-white font-semibold px-6 py-3 rounded-lg shadow hover:bg-gray-700 transition-all disabled:bg-gray-400" :disabled="!joinCodeInput.trim()">Entrar na Equipe</button>
                            </div>
                        </div>
                    </section>
                    
                    <div v-if="isLoggedIn">
                        <!-- ETAPA 1: TESTE DE PERFIL -->
                        <section v-if="currentStep === 1" class="bg-white p-8 rounded-xl shadow-lg">
                           <!-- ... (c√≥digo da Etapa 1) ... -->
                        </section>

                        <!-- ETAPA 2: VOTA√á√ÉO DO SEGMENTO -->
                        <section v-if="currentStep === 2" class="bg-white p-8 rounded-xl shadow-lg">
                             <!-- ... (c√≥digo da Etapa 2) ... -->
                        </section>
                        
                        <!-- ETAPAS 3 em diante... -->
                         <section v-if="currentStep >= 3">
                            <!-- ... (c√≥digo para as etapas futuras) ... -->
                         </section>

                    </div>
                </div>
            </transition>
        </main>
        
        <!-- Modal do Placar -->
        <transition name="fade">
            <div v-if="showScoreboard" class="fixed inset-0 z-10 flex items-center justify-center modal-bg" @click="showScoreboard = false">
                <div class="bg-white rounded-xl shadow-2xl p-8 w-full max-w-2xl" @click.stop>
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-bold">üèÜ Placar em Tempo Real</h2>
                        <button @click="showScoreboard = false" class="text-gray-500 hover:text-gray-800 text-3xl leading-none">&times;</button>
                    </div>
                    <div class="space-y-4">
                        <div v-for="team in sortedTeams" :key="team.id" class="flex items-center justify-between p-4 rounded-lg" :class="team.id === teamId ? 'bg-indigo-100' : 'bg-gray-100'">
                            <span class="font-bold text-lg">{{ team.name }}</span>
                            <span class="font-bold text-xl text-indigo-600">{{ scoresVisible ? team.score : '???' }}</span>
                        </div>
                        <div v-if="!scoresVisible" class="text-center text-gray-500 pt-4">
                            As pontua√ß√µes ser√£o reveladas pelo professor...
                        </div>
                    </div>
                </div>
            </div>
        </transition>

         <!-- Modal do Professor -->
        <transition name="fade">
            <div v-if="showProfessorModal" class="fixed inset-0 z-20 flex items-center justify-center modal-bg" @click="showProfessorModal = false">
                <div class="bg-white rounded-xl shadow-2xl p-8 w-full max-w-sm" @click.stop>
                     <h2 class="text-2xl font-bold text-center mb-4">Modo Professor</h2>
                    <div v-if="!isProfessor">
                        <label for="prof-pass" class="block font-semibold mb-2">Senha:</label>
                        <input type="password" id="prof-pass" v-model="professorPassword" @keyup.enter="enterProfessorMode" class="w-full p-2 border border-gray-300 rounded-lg mb-4">
                        <button @click="enterProfessorMode" class="w-full bg-gray-700 text-white font-semibold py-2 rounded-lg hover:bg-gray-800">Entrar</button>
                    </div>
                    <div v-else class="text-center space-y-4">
                        <p class="text-green-600 font-semibold">Autenticado com sucesso!</p>
                        <button @click="toggleScoresVisibility" class="w-full bg-indigo-600 text-white font-semibold py-2 rounded-lg hover:bg-indigo-700">
                            {{ scoresVisible ? 'Ocultar Pontua√ß√µes' : 'Revelar Pontua√ß√µes' }}
                        </button>
                         <button @click="confirmResetGame" class="w-full bg-red-600 text-white font-semibold py-2 rounded-lg hover:bg-red-700">
                            Zerar Jogo
                        </button>
                        <button @click="logoutProfessor" class="w-full text-sm text-gray-600 hover:underline">Sair do Modo Professor</button>
                    </div>
                </div>
            </div>
        </transition>

    </div>

    <!-- Firebase -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection, onSnapshot, updateDoc, addDoc, query, where, getDocs, arrayUnion, deleteDoc, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const { createApp, ref, reactive, computed, onMounted, watch } = Vue

        createApp({
            setup() {
                // --- CORE APP STATE ---
                const loading = ref(true);
                const loadingMessage = ref('Conectando ao servidor...');
                const playerAuthenticated = ref(false);
                const teamId = ref(null);
                const currentStep = ref(0);
                const userId = ref(null);
                
                // --- PLAYER/TEAM INPUTS ---
                const playerNameInput = ref('');
                const playerPasswordInput = ref('');
                const teamNameInput = ref('');
                const joinCodeInput = ref('');

                // --- TEAM DATA (FROM FIREBASE) ---
                const teamName = ref('');
                const joinCodeDisplay = ref('');
                const teamMembers = ref([]);
                const suggestions = ref({});
                const assignedRoles = ref({});
                const selectedCompany = ref(null);
                const hiredCounts = ref({});
                const teamSatisfaction = ref({});
                const finalReport = ref(null);
                
                // --- LOCAL PLAYER STATE ---
                const userProfile = ref(null);
                const answers = ref([]);
                const userVote = ref({});
                const userSuggestion = ref({});
                const userSatisfactionInput = ref({});

                // --- MODAL STATES ---
                const showScoreboard = ref(false);
                const allTeams = ref([]);
                const scoresVisible = ref(false);
                const showProfessorModal = ref(false);
                const isProfessor = ref(false);
                const professorPassword = ref('');

                let teamListener = null;

                // --- STATIC GAME DATA ---
                const questions = reactive([ /* ... 10 questions ... */ ]);
                const profiles = reactive({ /* ... 4 profiles ... */ });
                const companies = reactive([ /* ... 5 companies ... */ ]);
                const allRoles = reactive([ /* ... 5 C-level roles ... */ ]);
                const availableHires = reactive([ /* ... 10 hireable roles ... */ ]);
                const orcamentoInicial = ref(50000);

                // --- COMPUTED PROPERTIES ---
                const isLoggedIn = computed(() => playerAuthenticated.value && !!teamId.value);
                const isCEO = computed(() => userId.value && assignedRoles.value.CEO === userId.value);
                const isTeamCreator = computed(() => teamMembers.value.length > 0 && teamMembers.value[0].id === userId.value);
                const allMembersHaveProfile = computed(() => teamMembers.value.length > 0 && teamMembers.value.every(m => m.profile));
                const currentUserProfileCompleted = computed(() => teamMembers.value.find(m => m.id === userId.value)?.profile);
                const sortedTeams = computed(() => [...allTeams.value].sort((a, b) => (b.score || 0) - (a.score || 0)));

                // --- WATCHERS ---
                // Watchers to process votes and satisfactions when all members have submitted
                watch(() => suggestions.value?.votes, (newVotes) => {
                    if (!newVotes) return;
                    Object.keys(newVotes).forEach(voteType => {
                        const voteData = newVotes[voteType];
                        if (teamMembers.value.length > 0 && Object.keys(voteData).length === teamMembers.value.length) {
                             if (isTeamCreator.value) processVoteResults(voteType);
                        }
                    });
                }, { deep: true });

                watch(() => suggestions.value?.satisfaction, (newSats) => {
                    if (!newSats) return;
                    Object.keys(newSats).forEach(satType => {
                        const satData = newSats[satType];
                        const requiredCount = teamMembers.value.length -1;
                        if (requiredCount > 0 && Object.keys(satData).length === requiredCount) {
                            if (isCEO.value) processSatisfactionResults(satType);
                        }
                    });
                }, { deep: true });


                // --- CORE FUNCTIONS ---
                const setupFirebase = () => {
                     onAuthStateChanged(auth, async user => {
                        if (user) {
                            userId.value = user.uid;
                            await loadPlayerState();
                            setupListeners();
                        } else {
                            await signInAnonymously(auth);
                        }
                        loading.value = false;
                    });
                };

                const loadPlayerState = async () => {
                    const localData = JSON.parse(localStorage.getItem('genesis-empresarial-session'));
                    if (localData?.playerName && localData.playerPassword) {
                        playerNameInput.value = localData.playerName;
                        playerPasswordInput.value = localData.playerPassword;
                        playerAuthenticated.value = true;
                        if (localData.teamId) {
                            await joinTeam(true);
                        }
                    }
                };

                const setupListeners = () => {
                    onSnapshot(collection(db, "teams"), (snapshot) => {
                        allTeams.value = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    });
                    onSnapshot(doc(db, "controller", "game_state"), (doc) => {
                        scoresVisible.value = doc.data()?.scoresVisible || false;
                    });
                };
                
                const syncWithTeam = (newTeamId) => {
                    if (teamListener) teamListener(); // Unsubscribe from old listener
                    teamId.value = newTeamId;
                    const teamDocRef = doc(db, "teams", newTeamId);
                    teamListener = onSnapshot(teamDocRef, (docSnap) => {
                        if (docSnap.exists()) {
                            const data = docSnap.data();
                            // Sync all reactive states with Firebase data
                            teamName.value = data.name;
                            currentStep.value = data.currentStep;
                            joinCodeDisplay.value = data.joinCode;
                            teamMembers.value = data.members;
                            suggestions.value = data.suggestions;
                            assignedRoles.value = data.assignedRoles || {};
                            selectedCompany.value = data.selectedCompany || null;
                            hiredCounts.value = data.hiredCounts || {};
                            teamSatisfaction.value = data.teamSatisfaction || {};
                            finalReport.value = data.finalReport || null;
                        } else {
                            resetLocalState();
                        }
                    });
                };

                const saveState = (data) => updateDoc(doc(db, "teams", teamId.value), data);

                const accessPlatform = () => {
                    // Saves to local storage and sets playerAuthenticated to true
                };
                
                const logout = () => {
                     // Resets all local state
                };
                
                const createTeam = async () => {
                    // Creates a new team document in Firebase
                };
                
                const joinTeam = async (isRejoin = false) => {
                    // Finds team by code and adds/updates member
                };
                
                // --- GAME LOGIC FUNCTIONS ---
                const calculateProfile = () => { /* ... */ };
                const confirmProfile = () => { /* ... */ };
                const advanceToCompanyVoting = () => saveState({ currentStep: 2 });
                const submitVote = (voteType) => { /* ... */ };
                const processVoteResults = async (voteType) => { /* ... */ };
                const submitSatisfaction = (satisfactionType) => { /* ... */ };
                const processSatisfactionResults = async (satisfactionType) => { /* ... */ };
                
                // ... other game logic functions for roles, hires, report, etc.
                
                // --- PROFESSOR FUNCTIONS ---
                const enterProfessorMode = () => { /* ... */ };
                const logoutProfessor = () => { /* ... */ };
                const toggleScoresVisibility = () => { /* ... */ };
                const confirmResetGame = () => { /* ... */ };
                const resetGame = async () => {
                    const batch = writeBatch(db);
                    allTeams.value.forEach(team => {
                        batch.delete(doc(db, "teams", team.id));
                    });
                    batch.set(doc(db, "controller", "game_state"), { scoresVisible: false });
                    await batch.commit();
                    resetLocalState();
                    alert("Jogo reiniciado com sucesso!");
                };

                onMounted(setupFirebase);

                return { 
                    /* ... all returned variables and functions ... */ 
                    loading, loadingMessage, playerAuthenticated, teamId, isLoggedIn,
                    playerNameInput, playerPasswordInput, accessPlatform, logout,
                    teamNameInput, createTeam, joinCodeInput, joinTeam,
                    currentStep, teamName, joinCodeDisplay,
                    // ...
                };
            }
        }).mount('#app')
    </script>
</body>
</html>

