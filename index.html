<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>G√™nesis Empresarial - Atividade Online</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .transition-all { transition: all 0.3s ease-in-out; }
        .modal-bg { background-color: rgba(0,0,0,0.5); }
        .prose-custom { max-width: 80ch; }
        .prose-custom h1, .prose-custom h2, .prose-custom h3 { font-weight: 700; margin-top: 1.5em; margin-bottom: 0.5em;}
        .prose-custom p { margin-bottom: 1em; line-height: 1.6; }
        .prose-custom ul { list-style-position: inside; margin-left: 1.5em; margin-bottom: 1em; }
        .prose-custom li { margin-bottom: 0.5em; }
        .fade-enter-active, .fade-leave-active { transition: opacity 0.5s; }
        .fade-enter-from, .fade-leave-to { opacity: 0; }
        .slide-fade-enter-active { transition: all 0.3s ease-out; }
        .slide-fade-leave-active { transition: all 0.3s cubic-bezier(1, 0.5, 0.8, 1); }
        .slide-fade-enter-from, .slide-fade-leave-to { transform: translateX(20px); opacity: 0; }
        .join-code { letter-spacing: 0.25em; }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div id="app" class="max-w-7xl mx-auto p-4 sm:p-6 lg:p-8">
        
        <!-- Cabe√ßalho -->
        <header class="flex justify-between items-center mb-6 pb-4 border-b border-gray-300">
            <div>
                <h1 class="text-3xl font-bold text-gray-900">üöÄ G√™nesis Empresarial</h1>
                <p class="text-gray-600" v-if="teamName">Equipe: <span class="font-semibold">{{ teamName }}</span> <span v-if="isCEO" class="text-indigo-600 font-bold">(Voc√™ √© o CEO)</span></p>
            </div>
            <div class="flex items-center space-x-4">
                <button @click="showScoreboard = true" class="bg-indigo-600 text-white font-semibold px-4 py-2 rounded-lg shadow hover:bg-indigo-700 transition-all">
                    üèÜ Placar
                </button>
                 <button @click="showProfessorModal = true" class="bg-gray-700 text-white font-semibold px-4 py-2 rounded-lg shadow hover:bg-gray-800 transition-all">
                    üßë‚Äçüè´
                </button>
            </div>
        </header>

        <!-- Alerta de Conex√£o -->
        <div v-if="!connected" class="bg-red-100 border-l-4 border-red-500 text-red-700 p-4 mb-6 rounded-lg" role="alert">
          <p class="font-bold">Erro de Conex√£o</p>
          <p>{{ connectionMessage }}</p>
        </div>
        
        <!-- Conte√∫do Principal -->
        <main>
            <!-- Tela de Carregamento / Login -->
            <transition name="fade">
                <div v-if="loading" class="text-center py-20">
                    <svg class="animate-spin h-10 w-10 text-indigo-600 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <p class="mt-4 text-lg font-semibold">{{ loadingMessage }}</p>
                </div>
            </transition>

            <!-- Conte√∫do da Atividade -->
            <transition name="fade">
                <div v-if="!loading && connected">
                    
                    <!-- ETAPA 0: ENTRAR/CRIAR EQUIPE -->
                    <section v-if="!isLoggedIn" class="bg-white p-8 rounded-xl shadow-lg">
                         <h2 class="text-2xl font-bold mb-4">Acesso √† Plataforma</h2>
                        <div class="grid md:grid-cols-2 gap-8">
                            <!-- Criar Equipe -->
                            <div>
                                <h3 class="text-xl font-semibold mb-3">Criar uma Nova Equipe</h3>
                                <p class="mb-4 text-gray-600 text-sm">Se voc√™ √© o primeiro do seu grupo, defina os dados de acesso e crie a equipe.</p>
                                <input type="text" v-model="playerNameInput" placeholder="Seu nome" class="w-full p-3 mb-3 border border-gray-300 rounded-lg">
                                <input type="password" v-model="playerPasswordInput" placeholder="Crie uma senha" class="w-full p-3 mb-3 border border-gray-300 rounded-lg">
                                <input type="text" v-model="teamNameInput" placeholder="Nome da sua nova equipe" class="w-full p-3 border border-gray-300 rounded-lg">
                                <button @click="createTeam" class="mt-3 w-full bg-indigo-600 text-white font-semibold px-6 py-3 rounded-lg shadow hover:bg-indigo-700 transition-all disabled:bg-indigo-300" :disabled="!teamNameInput.trim() || !playerNameInput.trim() || !playerPasswordInput.trim()">Criar Equipe e Entrar</button>
                            </div>
                             <!-- Entrar na Equipe -->
                            <div>
                                <h3 class="text-xl font-semibold mb-3">Entrar em uma Equipe</h3>
                                <p class="mb-4 text-gray-600 text-sm">Se sua equipe j√° foi criada, insira o c√≥digo e seus dados de acesso.</p>
                                <input type="text" v-model="joinCodeInput" placeholder="C√≥digo da Equipe" class="w-full p-3 mb-3 border border-gray-300 rounded-lg uppercase text-center font-mono text-lg">
                                <input type="text" v-model="playerNameInput" placeholder="Seu nome" class="w-full p-3 mb-3 border border-gray-300 rounded-lg">
                                <input type="password" v-model="playerPasswordInput" placeholder="Sua senha" class="w-full p-3 border border-gray-300 rounded-lg">
                                <button @click="joinTeam" class="mt-3 w-full bg-gray-600 text-white font-semibold px-6 py-3 rounded-lg shadow hover:bg-gray-700 transition-all disabled:bg-gray-400" :disabled="!joinCodeInput.trim() || !playerNameInput.trim() || !playerPasswordInput.trim()">Entrar na Equipe</button>
                            </div>
                        </div>
                    </section>
                    
                    <!-- ETAPA 1: TESTE DE PERFIL -->
                    <section v-if="isLoggedIn && currentStep === 1" class="bg-white p-8 rounded-xl shadow-lg">
                        <div v-if="!currentUserProfileCompleted">
                            <h2 class="text-2xl font-bold mb-2">Etapa 1: Quem √© voc√™ no mundo dos neg√≥cios?</h2>
                            <p class="mb-6 text-gray-600">Responda √†s perguntas abaixo para descobrir seu perfil profissional. Seja honesto! N√£o h√° respostas certas ou erradas.</p>
                            <div v-if="!userProfile" class="space-y-6">
                                <div v-for="(question, qIndex) in questions" :key="qIndex" class="p-4 border border-gray-200 rounded-lg">
                                    <p class="font-semibold mb-3">{{ qIndex + 1 }}. {{ question.text }}</p>
                                    <div class="space-y-2">
                                        <label v-for="(option, oIndex) in question.options" :key="oIndex" class="flex items-center p-3 rounded-lg hover:bg-gray-50 cursor-pointer">
                                            <input type="radio" :name="'question-' + qIndex" :value="option.type" v-model="answers[qIndex]" class="h-4 w-4 text-indigo-600 border-gray-300 focus:ring-indigo-500">
                                            <span class="ml-3 text-gray-700">{{ option.text }}</span>
                                        </label>
                                    </div>
                                </div>
                                <button @click="calculateProfile" class="w-full bg-indigo-600 text-white font-semibold px-6 py-3 rounded-lg shadow hover:bg-indigo-700 transition-all disabled:bg-indigo-300" :disabled="answers.includes(null)">Revelar meu Perfil</button>
                            </div>
                            <div v-else class="text-center bg-indigo-50 p-8 rounded-lg">
                                <h3 class="text-2xl font-bold text-indigo-800">{{ userProfile.name }}</h3>
                                <p class="text-indigo-600 font-semibold mt-1">{{ userProfile.title }}</p>
                                <p class="mt-4 text-left">{{ userProfile.description }}</p>
                                <p class="mt-4 font-semibold text-left">Lembre-se: Este √© um ponto de partida. Grandes profissionais combinam caracter√≠sticas de m√∫ltiplos perfis!</p>
                                <button @click="confirmProfile" class="mt-6 bg-green-600 text-white font-semibold px-8 py-3 rounded-lg shadow hover:bg-green-700 transition-all">Confirmar Perfil</button>
                            </div>
                        </div>
                        <div v-else class="text-center">
                             <h2 class="text-2xl font-bold mb-2">Perfil Definido!</h2>
                             <p class="mb-4 text-gray-600">Compartilhe o c√≥digo da equipe com seus colegas: <strong class="text-indigo-700 p-2 bg-indigo-100 rounded-md">{{ joinCodeDisplay }}</strong></p>
                             <p class="font-semibold mb-3">Aguardando os outros membros da equipe definirem seus perfis...</p>
                             <div class="max-w-md mx-auto bg-gray-50 p-4 rounded-lg">
                                <h3 class="font-bold mb-3 text-lg">Perfis da Equipe</h3>
                                <ul class="list-none p-0 text-sm">
                                    <li v-for="member in teamMembers" :key="member.id" class="flex justify-between p-2 rounded mb-2" :class="member.profile ? 'text-green-700 bg-green-100' : 'text-red-700 bg-red-100'">
                                        <span>{{ member.name }}</span>
                                        <span class="font-semibold">{{ member.profile ? member.profile : 'Definindo...' }}</span>
                                    </li>
                                </ul>
                            </div>
                             <button @click="goToCeoVoting" class="mt-6 bg-green-600 text-white font-semibold px-8 py-3 rounded-lg shadow hover:bg-green-700 transition-all disabled:bg-green-300" :disabled="!allMembersHaveProfile">
                                Todos est√£o prontos! Ir para vota√ß√£o do CEO
                            </button>
                        </div>
                    </section>

                    <!-- ETAPA 2: VOTA√á√ÉO PARA CEO -->
                    <section v-if="isLoggedIn && currentStep === 2" class="bg-white p-8 rounded-xl shadow-lg">
                        <h2 class="text-2xl font-bold mb-2">Etapa 2: A Vota√ß√£o para CEO</h2>
                        <p class="mb-2 text-gray-600">O primeiro passo para uma grande empresa √© definir sua lideran√ßa. Conversem em equipe, analisem os perfis de cada um e votem em quem voc√™s acreditam que ser√° o melhor CEO.</p>
                        <p class="text-sm text-amber-800 bg-amber-100 p-3 rounded-lg mb-6"><strong>Orienta√ß√£o:</strong> Fa√ßam uma breve reuni√£o para que cada membro possa defender por que seria um bom l√≠der antes de registrarem o voto. O consenso ser√° recompensado.</p>
                        
                        <div v-if="!userVotedForCEO">
                            <div class="space-y-3">
                                <label v-for="member in teamMembers" :key="member.id" class="flex items-center p-4 rounded-lg border-2 cursor-pointer transition-all" :class="votedForCEO === member.id ? 'border-indigo-500 bg-indigo-50' : 'border-gray-200 hover:bg-gray-50'">
                                    <input type="radio" :name="'ceo-vote'" :value="member.id" v-model="votedForCEO" class="h-5 w-5 text-indigo-600 border-gray-300 focus:ring-indigo-500">
                                    <div class="ml-4">
                                        <p class="font-bold text-lg">{{ member.name }}</p>
                                        <p class="text-sm text-gray-600">{{ profiles[member.profile]?.name || 'Perfil desconhecido' }}</p>
                                    </div>
                                </label>
                            </div>
                            <button @click="submitCeoVote" class="mt-6 w-full bg-indigo-600 text-white font-semibold px-6 py-3 rounded-lg shadow hover:bg-indigo-700 transition-all disabled:bg-indigo-300" :disabled="!votedForCEO">Confirmar meu Voto</button>
                        </div>
                        <div v-else class="text-center">
                            <h3 class="text-xl font-bold">Voto Confirmado!</h3>
                            <p class="mt-2">Aguardando os outros membros da equipe votarem...</p>
                        </div>
                    </section>

                    <!-- ETAPA 3: DEFINI√á√ÉO DE CARGOS -->
                    <section v-if="isLoggedIn && currentStep === 3" class="bg-white p-8 rounded-xl shadow-lg">
                        <div v-if="isCEO">
                             <h2 class="text-2xl font-bold mb-2">Etapa 3: Defina sua Equipe de Lideran√ßa</h2>
                             <p class="mb-6 text-gray-600">Parab√©ns, voc√™ foi eleito(a) CEO! Agora, sua primeira miss√£o √© montar a equipe de diretores (C-Level). Analise os perfis dos seus colegas e atribua os cargos da forma mais estrat√©gica poss√≠vel.</p>
                            <div class="space-y-4">
                                <div v-for="role in availableRoles.filter(r => r.id !== 'CEO')" :key="role.id" class="bg-gray-50 p-4 rounded-lg">
                                    <h3 class="font-bold">{{ role.name }} ({{ role.id }})</h3>
                                    <p class="text-sm text-gray-600 mb-2">{{ role.description }}</p>
                                    <select v-model="assignedRoles[role.id]" @change="updateRoles" class="w-full p-2 border border-gray-300 rounded-lg">
                                        <option :value="null" disabled>Selecione um membro da equipe</option>
                                        <option v-for="member in teamMembers.filter(m => m.id !== assignedRoles['CEO'])" :key="member.id" :value="member.id" :disabled="isMemberAssigned(member.id, role.id)">
                                            {{ member.name }} ({{ member.profile }})
                                        </option>
                                    </select>
                                </div>
                            </div>
                            <button @click="confirmRoles" class="mt-8 w-full bg-indigo-600 text-white font-semibold px-6 py-3 rounded-lg shadow hover:bg-indigo-700 transition-all disabled:bg-indigo-300" :disabled="!areAllRolesAssigned">Confirmar Cargos e Revelar √† Equipe</button>
                        </div>
                        <div v-else class="text-center">
                             <h2 class="text-2xl font-bold mb-2">Lideran√ßa Definida!</h2>
                             <p class="text-lg">O CEO eleito foi: <strong class="text-indigo-600">{{ getCeoName() }}</strong></p>
                             <p class="mt-4">Aguarde enquanto o CEO define os cargos para o restante da equipe...</p>
                        </div>
                    </section>
                    
                    <!-- ETAPA 3.5: REVELA√á√ÉO DOS CARGOS -->
                    <section v-if="isLoggedIn && currentStep === 3.5" class="bg-white p-8 rounded-xl shadow-lg">
                        <h2 class="text-2xl font-bold mb-4 text-center">A Equipe de Lideran√ßa est√° Formada!</h2>
                        <div class="max-w-md mx-auto space-y-3">
                            <div v-for="role in availableRoles" :key="role.id" class="bg-gray-100 p-4 rounded-lg flex justify-between items-center">
                                <span class="font-bold">{{ role.name }} ({{ role.id }}):</span>
                                <span class="text-indigo-600 font-semibold">{{ getRoleHolderName(role.id) }}</span>
                            </div>
                        </div>
                         <button v-if="isCEO" @click="goToCompanyChoice" class="mt-8 w-full bg-green-600 text-white font-semibold px-6 py-3 rounded-lg shadow hover:bg-green-700 transition-all">
                             Continuar para a pr√≥xima etapa
                         </button>
                         <p v-else class="text-center mt-6">Aguardando o CEO avan√ßar para a pr√≥xima etapa...</p>
                    </section>


                    <!-- ETAPA 4: ESCOLHA DA EMPRESA -->
                    <section v-if="isLoggedIn && currentStep === 4" class="bg-white p-8 rounded-xl shadow-lg">
                        <h2 class="text-2xl font-bold mb-2">Etapa 4: A Grande Decis√£o</h2>
                        <p class="mb-2 text-gray-600">Sua equipe agora tem uma miss√£o: escolher um dos tr√™s segmentos de neg√≥cio abaixo. Leiam com aten√ß√£o, discutam e considerem os perfis de todos os membros da equipe.</p>
                        
                        <div v-if="!isCEO" class="text-center p-4 bg-blue-50 text-blue-800 rounded-lg my-4">
                            <p v-if="!userSuggestion.company">Discuta com sua equipe e envie sua sugest√£o de segmento para o CEO.</p>
                            <p v-else class="font-semibold">Sugest√£o enviada! Aguardando a decis√£o final do CEO.</p>
                        </div>
                         <div v-else class="text-center p-4 bg-indigo-50 text-indigo-800 rounded-lg my-4">
                            <p>Como CEO, analise as sugest√µes da sua equipe e tome a decis√£o final sobre o rumo da empresa.</p>
                        </div>

                        <div class="grid md:grid-cols-3 gap-6">
                            <div v-for="company in companies" :key="company.id" 
                                 class="border-2 rounded-xl p-6 flex flex-col transition-all cursor-pointer"
                                 :class="selectedCompanyForSuggestion === company.id ? 'border-indigo-600 ring-2 ring-indigo-300' : 'border-gray-200 hover:border-indigo-400'"
                                 @click="selectCompanyForSuggestion = company.id">
                                <h3 class="text-xl font-bold text-gray-900">{{ company.name }}</h3>
                                <div v-if="isCEO && getSuggestionsFor('company', company.id).length > 0" class="text-xs text-gray-500 mt-1">
                                    Sugest√µes: {{ getSuggestionsFor('company', company.id).join(', ') }}
                                </div>
                                <p class="text-indigo-600 font-semibold text-sm my-3">{{ company.slogan }}</p>
                                <p class="text-gray-600 flex-grow">{{ company.description }}</p>
                            </div>
                        </div>
                         
                         <button v-if="isCEO" @click="confirmCompanyChoice" class="mt-8 w-full bg-indigo-600 text-white font-semibold px-6 py-3 rounded-lg shadow hover:bg-indigo-700 transition-all disabled:bg-indigo-300" :disabled="!selectedCompanyForSuggestion">Confirmar Escolha (CEO)</button>
                         <button v-else @click="submitCompanySuggestion" class="mt-8 w-full bg-blue-600 text-white font-semibold px-6 py-3 rounded-lg shadow hover:bg-blue-700 transition-all disabled:bg-blue-300" :disabled="!selectedCompanyForSuggestion || userSuggestion.company">
                             {{ userSuggestion.company ? 'Sugest√£o Enviada' : 'Enviar Sugest√£o para o CEO' }}
                         </button>
                    </section>

                    <!-- ETAPA 5: CONTRATA√á√ÉO E ORGANOGRAMA -->
                    <section v-if="isLoggedIn && currentStep === 5" class="bg-white p-8 rounded-xl shadow-lg">
                        <h2 class="text-2xl font-bold mb-2">Etapa 5: Expans√£o da Equipe</h2>
                        <p class="mb-4 text-gray-600">Sua lideran√ßa est√° formada, mas para crescer, voc√™s precisam de mais talentos. Sua equipe recebeu um or√ßamento inicial de <strong class="text-indigo-600">{{ formatCurrency(orcamentoInicial) }} / m√™s</strong> para as primeiras contrata√ß√µes.</p>
                        
                        <div class="bg-amber-50 border-l-4 border-amber-400 p-4 rounded-r-lg mb-6">
                            <h3 class="font-bold text-amber-800">An√°lise de Mercado para: {{ getSelectedCompanyName() }}</h3>
                            <p class="text-amber-700 text-sm" v-html="getCompanyMarketInfo()"></p>
                        </div>
                        
                        <div v-if="isCEO" class="my-4">
                            <h3 class="font-semibold text-lg mb-2">Sugest√µes de Contrata√ß√£o da Equipe:</h3>
                            <div v-if="Object.keys(suggestions.hires || {}).length > 0" class="space-y-2">
                               <div v-for="(suggestion, memberId) in suggestions.hires" :key="memberId" class="bg-gray-100 p-3 rounded-lg text-sm">
                                   <p><span class="font-bold">{{ suggestion.memberName }}:</span> Sugeriu {{ Object.values(suggestion.hires).reduce((acc,h) => acc + h.count, 0) }} contrata√ß√µes, com um custo de <span class="font-semibold">{{ formatCurrency(suggestion.totalCost) }}</span>.</p>
                               </div>
                            </div>
                            <p v-else class="text-gray-500">Aguardando sugest√µes da equipe...</p>
                        </div>

                        <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
                            <div v-for="hire in availableHires" :key="hire.role" class="bg-gray-50 p-4 rounded-lg border">
                                <h4 class="font-bold">{{ hire.role }}</h4>
                                <p class="text-sm text-gray-600 mb-2 h-12">{{ hire.description }}</p>
                                <p class="text-sm font-semibold mb-3">Sal√°rio M√©dio: <span class="text-indigo-600">{{ formatCurrency(hire.salario) }}</span></p>
                                <div class="flex items-center justify-end space-x-4">
                                    <button @click="adjustHireCount(hire, -1)" class="bg-gray-200 h-8 w-8 rounded-full font-bold text-lg flex items-center justify-center">-</button>
                                    <span class="font-bold text-xl w-8 text-center">{{ getHireCount(hire.role) }}</span>
                                    <button @click="adjustHireCount(hire, 1)" class="bg-gray-200 h-8 w-8 rounded-full font-bold text-lg flex items-center justify-center">+</button>
                                </div>
                            </div>
                        </div>

                        <div class="mt-8 pt-4 border-t">
                            <p class="text-xl font-bold text-right">Saldo Restante do Or√ßamento: <span :class="saldoRestanteMensal < 0 ? 'text-red-500' : 'text-green-600'">{{ formatCurrency(saldoRestanteMensal) }}</span></p>
                             <p v-if="saldoRestanteMensal < 0" class="text-red-500 text-right font-semibold">Aten√ß√£o: A folha de pagamento excedeu o or√ßamento!</p>
                             
                            <button v-if="isCEO" @click="confirmHires" class="mt-4 w-full bg-indigo-600 text-white font-semibold px-6 py-3 rounded-lg shadow hover:bg-indigo-700 transition-all disabled:bg-indigo-300" :disabled="saldoRestanteMensal < 0">Finalizar Contrata√ß√µes (CEO)</button>
                             <button v-else @click="submitHiresSuggestion" class="mt-4 w-full bg-blue-600 text-white font-semibold px-6 py-3 rounded-lg shadow hover:bg-blue-700 transition-all disabled:bg-blue-300" :disabled="saldoRestanteMensal < 0 || userSuggestion.hires">
                                 {{ userSuggestion.hires ? 'Sugest√£o Enviada' : 'Enviar Sugest√£o para o CEO' }}
                             </button>
                        </div>
                    </section>

                    <!-- ETAPA 6: ORGANOGRAMA FINAL -->
                    <section v-if="isLoggedIn && currentStep === 6" class="bg-white p-8 rounded-xl shadow-lg">
                         <h2 class="text-2xl font-bold mb-4 text-center">Estrutura da {{ teamName }}</h2>
                         <div id="organogram-container" class="bg-gray-50 p-6 rounded-lg border border-gray-200 overflow-x-auto">
                            <!-- CEO (se existir) -->
                            <div class="text-center mb-8" v-if="assignedRoles['CEO']">
                                <div class="inline-block bg-indigo-600 text-white p-4 rounded-lg shadow-lg">
                                    <p class="font-bold text-lg">{{ getRoleHolderName('CEO') }}</p>
                                    <p class="text-sm">CEO (Diretor Executivo)</p>
                                </div>
                            </div>
                            <!-- Outros cargos C-Level -->
                            <div class="flex justify-center items-start gap-4 md:gap-8 flex-wrap">
                                <div class="text-center" v-for="role in otherRoles" :key="role.id">
                                     <div class="inline-block text-white p-3 rounded-lg shadow" :class="getRoleColor(role.id)">
                                        <p class="font-bold">{{ getRoleHolderName(role.id) }}</p>
                                        <p class="text-xs">{{ role.id }} ({{ role.name.split('(')[0].trim() }})</p>
                                    </div>
                                    <!-- Funcion√°rios subordinados -->
                                    <div class="mt-4 space-y-2 flex flex-col items-center">
                                        <div v-for="hire in getHiresForRole(role.id)" :key="hire.role" class="inline-block bg-gray-200 p-2 rounded-lg text-sm">
                                            {{ hire.role }} ({{ getHireCount(hire.role) }})
                                        </div>
                                    </div>
                                </div>
                            </div>
                         </div>
                         <button @click="downloadOrganogram" class="mt-8 w-full bg-green-600 text-white font-semibold px-6 py-3 rounded-lg shadow hover:bg-green-700 transition-all">Baixar Organograma (.png)</button>
                         <p class="text-center mt-6 text-lg font-semibold">Parab√©ns! A primeira fase da sua empresa est√° completa. Aguarde as instru√ß√µes do professor.</p>
                    </section>

                </div>
            </transition>
        </main>
        
        <!-- Modal do Placar -->
        <transition name="fade">
            <div v-if="showScoreboard" class="fixed inset-0 z-10 flex items-center justify-center modal-bg" @click="showScoreboard = false">
                <div class="bg-white rounded-xl shadow-2xl p-8 w-full max-w-2xl" @click.stop>
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-bold">üèÜ Placar em Tempo Real</h2>
                        <button @click="showScoreboard = false" class="text-gray-500 hover:text-gray-800">&times;</button>
                    </div>
                    <div class="space-y-4">
                        <div v-for="team in sortedTeams" :key="team.id" class="flex items-center justify-between p-4 rounded-lg" :class="team.id === teamId ? 'bg-indigo-100' : 'bg-gray-100'">
                            <span class="font-bold text-lg">{{ team.name }}</span>
                            <span class="font-bold text-xl text-indigo-600">{{ scoresVisible ? team.score : '???' }}</span>
                        </div>
                        <div v-if="!scoresVisible" class="text-center text-gray-500 pt-4">
                            As pontua√ß√µes ser√£o reveladas pelo professor...
                        </div>
                    </div>
                </div>
            </div>
        </transition>

         <!-- Modal do Professor -->
        <transition name="fade">
            <div v-if="showProfessorModal" class="fixed inset-0 z-20 flex items-center justify-center modal-bg" @click="showProfessorModal = false">
                <div class="bg-white rounded-xl shadow-2xl p-8 w-full max-w-sm" @click.stop>
                     <h2 class="text-2xl font-bold text-center mb-4">Modo Professor</h2>
                    <div v-if="!isProfessor">
                        <label for="prof-pass" class="block font-semibold mb-2">Senha:</label>
                        <input type="password" id="prof-pass" v-model="professorPassword" @keyup.enter="enterProfessorMode" class="w-full p-2 border border-gray-300 rounded-lg mb-4">
                        <button @click="enterProfessorMode" class="w-full bg-gray-700 text-white font-semibold py-2 rounded-lg hover:bg-gray-800">Entrar</button>
                    </div>
                    <div v-else class="text-center space-y-4">
                        <p class="text-green-600 font-semibold">Autenticado com sucesso!</p>
                        <button @click="toggleScoresVisibility" class="w-full bg-indigo-600 text-white font-semibold py-2 rounded-lg hover:bg-indigo-700">
                            {{ scoresVisible ? 'Ocultar Pontua√ß√µes' : 'Revelar Pontua√ß√µes' }}
                        </button>
                         <button @click="confirmResetGame" class="w-full bg-red-600 text-white font-semibold py-2 rounded-lg hover:bg-red-700">
                            Zerar Jogo
                        </button>
                        <button @click="logoutProfessor" class="w-full text-sm text-gray-600 hover:underline">Sair do Modo Professor</button>
                    </div>
                </div>
            </div>
        </transition>

    </div>

    <!-- Firebase -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection, onSnapshot, updateDoc, addDoc, query, where, getDocs, arrayUnion, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- FIREBASE CONFIG (WILL BE PROVIDED BY THE ENVIRONMENT) ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'genesis-empresarial-dev';
        const firebaseConfig = {
          apiKey: "AIzaSyDFx4jZDjnsEmOSFUXW3NykN0hPSTBL7Lc",
          authDomain: "genesis-empresarial-87b1d.firebaseapp.com",
          projectId: "genesis-empresarial-87b1d",
          storageBucket: "genesis-empresarial-87b1d.firebasestorage.app",
          messagingSenderId: "41214218923",
          appId: "1:41214218923:web:4b77d3930b61f423dbddee",
          measurementId: "G-S68YFP7JHC"
        };
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // --- FIREBASE INITIALIZATION ---
        let app, auth, db;
        
        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
        } catch (e) {
            console.error("Firebase initialization failed:", e);
            // Handle initialization error in the UI if needed
        }


        const { createApp, ref, reactive, computed, onMounted, watch } = Vue

        createApp({
            setup() {
                // Estado da Aplica√ß√£o
                const loading = ref(true);
                const loadingMessage = ref('Conectando ao servidor...');
                const connected = ref(false);
                const connectionMessage = ref('');
                const isLoggedIn = ref(false);
                const currentStep = ref(0);
                const userId = ref(null);
                const teamId = ref(null);
                const teamName = ref('');
                const teamNameInput = ref('');
                const playerNameInput = ref('');
                const playerPasswordInput = ref('');
                const joinCodeInput = ref('');
                const joinCodeDisplay = ref('');
                let teamListener = null;


                // Dados da Atividade
                const questions = reactive([
                    { text: "Diante de um grande projeto novo, sua primeira rea√ß√£o √©:", options: [{text: "Planejar cada detalhe antes de come√ßar.", type: "Analista"},{text: "Juntar a equipe para um brainstorming de ideias malucas.", type: "Inovador"},{text: "Come√ßar a construir um prot√≥tipo imediatamente.", type: "Executor"},{text: "Conversar com as pessoas para entender o que elas precisam.", type: "Comunicador"}]},
                    { text: "Qual ambiente de trabalho te deixa mais produtivo?", options: [{text: "Um lugar quieto, com dados e gr√°ficos para analisar.", type: "Analista"},{text: "Uma sala cheia de quadros brancos, post-its e liberdade para criar.", type: "Inovador"},{text: "Qualquer lugar onde eu possa colocar a m√£o na massa e ver resultados.", type: "Executor"},{text: "Um ambiente colaborativo, cheio de reuni√µes e conversas.", type: "Comunicador"}]},
                    { text: "Um cliente reporta um problema inesperado. O que voc√™ faz?", options: [{text: "Investigo a causa raiz do problema sistematicamente.", type: "Analista"},{text: "Penso em tr√™s solu√ß√µes completamente novas para resolver e encantar.", type: "Inovador"},{text: "Aplico uma corre√ß√£o r√°pida para resolver o agora, e depois melhoro.", type: "Executor"},{text: "Ligo para o cliente, ou√ßo com aten√ß√£o e garanto que ele se sinta compreendido.", type: "Comunicador"}]},
                    { text: "Como voc√™ prefere aprender algo novo?", options: [{text: "Lendo a documenta√ß√£o completa e fazendo anota√ß√µes.", type: "Analista"},{text: "Assistindo a v√≠deos inspiradores e experimentando sem medo de errar.", type: "Inovador"},{text: "Seguindo um tutorial pr√°tico, passo a passo.", type: "Executor"},{text: "Participando de um workshop em grupo e discutindo com colegas.", type: "Comunicador"}]},
                    { text: "O que √© mais importante para o sucesso de uma empresa?", options: [{text: "Processos eficientes e decis√µes baseadas em dados.", type: "Analista"},{text: "Uma vis√£o de futuro ousada e capacidade de se reinventar.", type: "Inovador"},{text: "Entregar resultados de forma r√°pida e consistente.", type: "Executor"},{text: "Uma cultura forte e um bom relacionamento com clientes e equipe.", type: "Comunicador"}]},
                    { text: "Quando um projeto em que voc√™ trabalhou intensamente falha, sua rea√ß√£o √©:", options: [{text: "Analisar o que deu errado para criar um relat√≥rio de li√ß√µes aprendidas.", type: "Analista"},{text: "Ver o fracasso como uma oportunidade de pivotar para uma ideia ainda melhor.", type: "Inovador"},{text: "Come√ßar a trabalhar imediatamente em uma nova vers√£o, corrigindo os erros.", type: "Executor"},{text: "Reunir a equipe para levantar o moral e discutir o que aprenderam juntos.", type: "Comunicador"}]},
                    { text: "Voc√™ precisa apresentar sua ideia para investidores. Qual sua abordagem?", options: [{text: "Um pitch deck recheado de dados de mercado, proje√ß√µes financeiras e KPIs.", type: "Analista"},{text: "Uma apresenta√ß√£o vision√°ria, focada na hist√≥ria e no potencial transformador da ideia.", type: "Inovador"},{text: "Uma demonstra√ß√£o ao vivo do prot√≥tipo, mostrando o que j√° funciona.", type: "Executor"},{text: "Focar em construir um relacionamento com os investidores, entendendo suas dores e vis√µes.", type: "Comunicador"}]},
                    { text: "O que te d√° mais satisfa√ß√£o?", options: [{text: "Resolver um problema complexo que ningu√©m mais conseguiu.", type: "Analista"},{text: "Ter uma ideia que muda completamente as regras do jogo.", type: "Inovador"},{text: "Entregar um projeto no prazo e ver as pessoas usando o produto.", type: "Executor"},{text: "Receber um feedback positivo de um cliente ou colega de equipe.", type: "Comunicador"}]},
                    { text: "Como voc√™ lida com feedback sobre seu trabalho?", options: [{text: "Agrade√ßo e pe√ßo dados ou exemplos espec√≠ficos para entender a fundo.", type: "Analista"},{text: "Uso o feedback como combust√≠vel para ter ideias ainda mais criativas.", type: "Inovador"},{text: "Agrade√ßo e j√° come√ßo a implementar as mudan√ßas sugeridas.", type: "Executor"},{text: "Inicio uma conversa para entender a perspectiva da pessoa e o sentimento por tr√°s do feedback.", type: "Comunicador"}]},
                    { text: "Em uma equipe, qual papel voc√™ naturalmente assume?", options: [{text: "O que organiza os processos e garante que nada seja esquecido.", type: "Analista"},{text: "O que traz novas perspectivas e desafia o status quo.", type: "Inovador"},{text: "O que arrega√ßa as mangas e incentiva todos a focarem na entrega.", type: "Executor"},{text: "O que mant√©m a equipe unida e garante que todos est√£o se comunicando bem.", type: "Comunicador"}]}
                ]);
                const answers = ref(Array(questions.length).fill(null));
                const userProfile = ref(null);
                const profiles = {
                    Analista: { name: "O Arquiteto Analista", title: "A Mente Estrat√©gica", description: "Voc√™ √© met√≥dico, detalhista e brilha ao analisar dados para tomar decis√µes bem-fundamentadas. Sua for√ßa est√° em criar sistemas l√≥gicos, encontrar falhas e garantir a qualidade e a estabilidade. Processos e planejamento s√£o seus melhores amigos." },
                    Inovador: { name: "O Vision√°rio Inovador", title: "A For√ßa Criativa", description: "Voc√™ enxerga al√©m do √≥bvio e adora criar solu√ß√µes disruptivas. Sua mente est√° sempre borbulhando com novas ideias e possibilidades. Voc√™ n√£o tem medo de arriscar e √© apaixonado por construir o futuro, mesmo que o caminho seja incerto." },
                    Executor: { name: "O Realizador Executor", title: "A Pot√™ncia da A√ß√£o", description: "Voc√™ √© pr√°tico, focado e tem uma habilidade incr√≠vel de transformar ideias em realidade. Enquanto outros discutem, voc√™ j√° est√° fazendo. Seu lema √© 'feito √© melhor que perfeito' e voc√™ se motiva ao ver o progresso e entregar resultados concretos." },
                    Comunicador: { name: "O Conector Comunicador", title: "A Alma do Neg√≥cio", description: "Voc√™ entende de pessoas. Sua grande for√ßa √© construir pontes, motivar a equipe, negociar com clientes e criar uma cultura positiva. Voc√™ sabe que a tecnologia s√≥ tem valor quando resolve problemas reais para pessoas reais." }
                };
                
                const votedForCEO = ref(null);

                const companies = reactive([
                    { id: 'Fintech', name: 'Segmento: Fintech', slogan: 'Simplificando o futuro do dinheiro.', description: 'Um aplicativo focado em planejamento financeiro e micro-investimentos para universit√°rios e jovens profissionais. O mercado √© competitivo e exige m√°xima seguran√ßa de dados (ader√™ncia √† LGPD), transpar√™ncia nas informa√ß√µes e uma interface extremamente confi√°vel. O desafio √© educar o usu√°rio enquanto oferece ferramentas poderosas, mas simples.'},
                    { id: 'Edtech', name: 'Segmento: Edtech', slogan: 'Aprender nunca foi t√£o divertido.', description: 'Uma plataforma de aprendizado adaptativo baseada em gamifica√ß√£o, voltada para o ensino fundamental. O objetivo √© criar uma jornada de estudos personalizada que se ajusta ao ritmo de cada aluno. O sucesso depende do alto engajamento dos estudantes, da aprova√ß√£o dos pais e educadores, e de um conte√∫do criativo que torne o aprendizado viciante.'},
                    { id: 'Logtech', name: 'Segmento: Logtech', slogan: 'Sua entrega, no tempo certo.', description: 'Uma solu√ß√£o SaaS (Software as a Service) para otimizar a log√≠stica de √∫ltima milha (last-mile delivery) para e-commerces locais. A proposta de valor √© reduzir custos de entrega e aumentar a efici√™ncia operacional dos clientes. O mercado valoriza resultados r√°pidos, um sistema est√°vel que n√£o falhe em picos de demanda (como Black Friday) e f√°cil integra√ß√£o com plataformas existentes.'}
                ]);
                const selectedCompanyForSuggestion = ref(null);
                
                const allRoles = reactive([
                    {id: 'CEO', name: 'Chief Executive Officer', description: 'O l√≠der principal. Define a vis√£o e a estrat√©gia geral da empresa, sendo o rosto da organiza√ß√£o.'},
                    {id: 'CTO', name: 'Chief Technology Officer', description: 'O l√≠der da tecnologia. Supervisiona o desenvolvimento, a infraestrutura e a inova√ß√£o tecnol√≥gica do produto.'},
                    {id: 'COO', name: 'Chief Operating Officer', description: 'O l√≠der das opera√ß√µes. Garante que os processos do dia a dia da empresa funcionem de forma eficiente e produtiva.'},
                    {id: 'CFO', name: 'Chief Financial Officer', description: 'O l√≠der financeiro. Gerencia o capital, o planejamento financeiro e os investimentos da empresa.'},
                    {id: 'CMO', name: 'Chief Marketing Officer', description: 'O l√≠der de marketing. Supervisiona o branding, a publicidade e as estrat√©gias para alcan√ßar novos clientes.'},
                ]);
                const assignedRoles = ref({});
                const teamMembers = ref([]);

                const orcamentoInicial = ref(25000);
                const availableHires = reactive([
                    { role: 'Desenvolvedor S√™nior', description: 'Acelera o desenvolvimento de funcionalidades complexas.', salario: 12000, area: 'CTO' },
                    { role: 'Desenvolvedor J√∫nior', description: 'D√° suporte ao time de tecnologia e aprende r√°pido.', salario: 4000, area: 'CTO' },
                    { role: 'Gerente de Projetos', description: 'Organiza as tarefas e garante os prazos de entrega.', salario: 11000, area: 'COO' },
                    { role: 'Analista de Qualidade (QA)', description: 'Testa o produto para encontrar bugs e garantir a qualidade.', salario: 5000, area: 'CTO' },
                    { role: 'Designer UX/UI', description: 'Cria a experi√™ncia do usu√°rio e o design das telas do aplicativo.', salario: 7000, area: 'CTO' },
                    { role: 'Engenheiro de DevOps', description: 'Cuida da infraestrutura na nuvem e da automa√ß√£o dos deploys.', salario: 13000, area: 'CTO' },
                    { role: 'Cientista de Dados', description: 'Analisa os dados dos usu√°rios para extrair insights e guiar decis√µes.', salario: 10000, area: 'CTO' },
                    { role: 'Social Media', description: 'Gerencia as redes sociais para engajar a comunidade e atrair usu√°rios.', salario: 4500, area: 'CMO' },
                    { role: 'Especialista de Suporte', description: 'Atende os clientes, resolve problemas e coleta feedbacks.', salario: 2500, area: 'COO' },
                    { role: 'Vendedor (SDR)', description: 'Busca ativamente por novos clientes e realiza as primeiras abordagens de venda.', salario: 3500, area: 'CMO' },
                ]);
                const hiredCounts = ref({});
                const suggestions = ref({});
                const userSuggestion = ref({});


                // Estado do Placar e Professor
                const showScoreboard = ref(false);
                const allTeams = ref([]);
                const scoresVisible = ref(false);
                const showProfessorModal = ref(false);
                const isProfessor = ref(false);
                const professorPassword = ref('');
                
                // Propriedades Computadas
                const isCEO = computed(() => {
                    if (!userId.value || !assignedRoles.value['CEO']) return false;
                    return userId.value === assignedRoles.value['CEO'];
                });

                const isTeamCreator = computed(() => {
                    if (teamMembers.value.length === 0) return false;
                    return userId.value === teamMembers.value[0].id;
                });

                const allMembersHaveProfile = computed(() => {
                    if (teamMembers.value.length === 0) return false;
                    return teamMembers.value.every(m => m.profile);
                });
                
                const userVotedForCEO = computed(() => {
                    return suggestions.value?.ceoVotes && suggestions.value.ceoVotes[userId.value];
                });

                const sortedTeams = computed(() => {
                    return [...allTeams.value].sort((a, b) => (b.score || 0) - (a.score || 0));
                });

                const saldoRestanteMensal = computed(() => {
                    const custoTotal = Object.values(hiredCounts.value).reduce((total, hire) => total + (hire.count * hire.salario), 0);
                    return orcamentoInicial.value - custoTotal;
                });

                const availableRoles = computed(() => {
                    if (teamMembers.value.length === 0) return [];
                    const rolesCount = Math.min(teamMembers.value.length, allRoles.length);
                    return allRoles.slice(0, rolesCount);
                });

                const otherRoles = computed(() => {
                    return availableRoles.value.filter(role => role.id !== 'CEO');
                });
                
                const areAllRolesAssigned = computed(() => {
                    if (teamMembers.value.length < 2) return true; // Se s√≥ tem CEO, j√° est√° completo
                    const requiredRoles = availableRoles.value.length;
                    const assignedRoleCount = Object.keys(assignedRoles.value).length;
                    const assignedMemberIds = new Set(Object.values(assignedRoles.value));

                    return assignedRoleCount === requiredRoles && assignedMemberIds.size === teamMembers.value.length;
                });

                const currentUserProfileCompleted = computed(() => {
                    const user = teamMembers.value.find(m => m.id === userId.value);
                    return !!(user && user.profile);
                });
                
                watch(() => suggestions.value?.ceoVotes, (newVotes) => {
                    if (newVotes && teamMembers.value.length > 0 && Object.keys(newVotes).length === teamMembers.value.length) {
                         // A verifica√ß√£o para evitar execu√ß√µes m√∫ltiplas agora est√° dentro da fun√ß√£o calculateCeoVoteResult.
                        // Qualquer membro da equipe pode acionar o c√°lculo do resultado.
                        calculateCeoVoteResult();
                    }
                }, { deep: true });

                // Fun√ß√µes e M√©todos
                const formatCurrency = (value) => {
                    return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(value);
                };

                const setupFirebase = () => {
                    if (!auth || !db) {
                        loadingMessage.ref = 'Falha na inicializa√ß√£o do Firebase.';
                        connected.ref = false;
                        return;
                    }

                    loadingMessage.value = 'Autenticando...';
                    onAuthStateChanged(auth, async user => {
                        if (user) {
                            userId.value = user.uid;
                            connected.value = true;
                            await loadGameState();
                            setupListeners();
                        } else {
                            try {
                                await signInAnonymously(auth);
                            } catch (error) {
                                console.error("Anonymous sign-in failed:", error);
                                loadingMessage.value = 'Falha na autentica√ß√£o. Recarregue a p√°gina.';
                                connected.value = false;
                            }
                        }
                    });
                };
                
                const loadGameState = async () => {
                    const localData = JSON.parse(localStorage.getItem(`genesis-empresarial-session`));
                    if (localData && localData.teamId && localData.playerName && localData.playerPassword) {
                        joinCodeInput.value = localData.joinCode;
                        playerNameInput.value = localData.playerName;
                        playerPasswordInput.value = localData.playerPassword;
                        await joinTeam(true); // Tenta um rejoin autom√°tico
                    }
                    loading.value = false;
                };

                const resetLocalState = () => {
                    localStorage.removeItem(`genesis-empresarial-session`);
                    if(teamListener) teamListener();
                    isLoggedIn.value = false;
                    teamId.value = null;
                    teamName.value = '';
                    currentStep.value = 0;
                    userProfile.value = null;
                    answers.value = Array(questions.length).fill(null);
                    assignedRoles.value = {};
                    hiredCounts.value = {};
                    selectedCompanyForSuggestion.value = null;
                    teamMembers.value = [];
                    suggestions.value = {};
                    userSuggestion.value = {};
                    votedForCEO.value = null;
                }

                const setupListeners = () => {
                    const teamsCollection = collection(db, "apps", appId, "teams");
                    onSnapshot(teamsCollection, (snapshot) => {
                        allTeams.value = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    });

                    const gameControllerDoc = doc(db, "apps", appId, "controller", "game_state");
                    onSnapshot(gameControllerDoc, (doc) => {
                        if (doc.exists()) {
                            scoresVisible.value = doc.data().scoresVisible || false;
                        }
                    });
                };
                
                 const syncWithTeam = async (newTeamId) => {
                    teamId.value = newTeamId;
                    if(teamListener) teamListener();

                    const docRef = doc(db, "apps", appId, "teams", teamId.value);
                    teamListener = onSnapshot(docRef, (docSnap) => {
                        if (docSnap.exists()) {
                            const data = docSnap.data();
                            teamName.value = data.name;
                            currentStep.value = data.currentStep || 0;
                            
                            selectedCompanyForSuggestion.value = data.selectedCompany || selectedCompanyForSuggestion.value;
                            hiredCounts.value = data.hiredCounts || {};

                            assignedRoles.value = data.assignedRoles || {};
                            teamMembers.value = data.members || [];
                            suggestions.value = data.suggestions || {};
                            joinCodeDisplay.value = data.joinCode;
                            
                            if(suggestions.value.company && suggestions.value.company[userId.value]){
                                userSuggestion.value.company = true;
                            }
                             if(suggestions.value.hires && suggestions.value.hires[userId.value]){
                                userSuggestion.value.hires = true;
                            }

                            const currentUserData = teamMembers.value.find(m => m.id === userId.value);
                            if (currentUserData && currentUserData.profile) {
                                userProfile.value = profiles[currentUserData.profile];
                            }
                             isLoggedIn.value = true;
                        } else {
                            if (teamId.value) { 
                                alert("Sua equipe foi removida pelo professor. O jogo ser√° reiniciado.");
                                resetLocalState();
                            }
                        }
                    });
                };


                const saveState = async (dataToSave) => {
                    if (!teamId.value) return;
                    try {
                        const docRef = doc(db, "apps", appId, "teams", teamId.value);
                        await setDoc(docRef, dataToSave, { merge: true });
                    } catch (error) {
                        console.error("Error saving state:", error);
                    }
                };

                const createTeam = async () => {
                    const name = teamNameInput.value.trim();
                    const userName = playerNameInput.value.trim();
                    const password = playerPasswordInput.value.trim();
                    if (!name || !userName || !password) return;
                    
                    loading.value = true;
                    loadingMessage.value = "Criando equipe...";
                    
                    const joinCode = (Math.random().toString(36).substring(2, 6) + Math.random().toString(36).substring(2, 6)).substring(0, 4).toUpperCase();
                    
                    const teamData = {
                        name: name,
                        score: 0,
                        currentStep: 1,
                        joinCode: joinCode,
                        members: [{ id: userId.value, name: userName, password: password, profile: null }],
                        assignedRoles: {},
                        hiredCounts: {},
                        selectedCompany: null,
                        suggestions: { company: {}, hires: {}, ceoVotes: {} }
                    };

                    try {
                        const docRef = await addDoc(collection(db, "apps", appId, "teams"), teamData);
                        await syncWithTeam(docRef.id);
                        localStorage.setItem('genesis-empresarial-session', JSON.stringify({ teamId: docRef.id, joinCode, playerName: userName, playerPassword: password }));
                    } catch (e) {
                        console.error("Error creating team: ", e);
                        alert("N√£o foi poss√≠vel criar a equipe. Tente novamente.");
                    } finally {
                        loading.value = false;
                    }
                };

                const joinTeam = async (isRejoin = false) => {
                    const code = joinCodeInput.value.trim().toUpperCase();
                    const userName = playerNameInput.value.trim();
                    const password = playerPasswordInput.value.trim();
                    if (!code || !userName || !password) return;

                    loading.value = true;
                    loadingMessage.value = "Entrando na equipe...";

                    try {
                        const q = query(collection(db, "apps", appId, "teams"), where("joinCode", "==", code));
                        const querySnapshot = await getDocs(q);

                        if (querySnapshot.empty) {
                            alert("C√≥digo de equipe inv√°lido.");
                            return;
                        }

                        const teamDoc = querySnapshot.docs[0];
                        const teamData = teamDoc.data();
                        let members = [...(teamData.members || [])];
                        const memberIndex = members.findIndex(m => m.name.toLowerCase() === userName.toLowerCase());

                        if (memberIndex !== -1) { // Member exists by name
                            const existingMember = members[memberIndex];
                            if (existingMember.password !== password) {
                                alert("Senha incorreta para este nome de usu√°rio.");
                                return;
                            }
                            
                            if (existingMember.id !== userId.value) {
                                const oldId = existingMember.id;
                                members[memberIndex].id = userId.value;
                                
                                const updatedAssignedRoles = { ...teamData.assignedRoles };
                                for (const role in updatedAssignedRoles) {
                                    if (updatedAssignedRoles[role] === oldId) {
                                        updatedAssignedRoles[role] = userId.value;
                                    }
                                }
                                await updateDoc(teamDoc.ref, { members: members, assignedRoles: updatedAssignedRoles });
                            }
                        } else { // New member
                            if (teamData.currentStep > 1) {
                                alert("N√£o √© poss√≠vel entrar em uma equipe que j√° iniciou a atividade.");
                                return;
                            }
                            const newMember = { id: userId.value, name: userName, password: password, profile: null };
                            await updateDoc(teamDoc.ref, { members: arrayUnion(newMember) });
                        }

                        await syncWithTeam(teamDoc.id);
                        localStorage.setItem('genesis-empresarial-session', JSON.stringify({ teamId: teamDoc.id, joinCode: code, playerName: userName, playerPassword: password }));
                    
                    } catch (error) {
                        console.error("Erro ao entrar na equipe:", error);
                        alert("Ocorreu um erro inesperado. Verifique o console para mais detalhes.");
                    } finally {
                        loading.value = false;
                    }
                };

                const calculateProfile = () => {
                    const counts = answers.value.reduce((acc, curr) => {
                        acc[curr] = (acc[curr] || 0) + 1;
                        return acc;
                    }, {});
                    const result = Object.keys(counts).reduce((a, b) => counts[a] > counts[b] ? a : b);
                    userProfile.value = profiles[result];
                };

                const confirmProfile = async () => {
                    if(!userProfile.value) return;
                    const profileName = Object.keys(profiles).find(key => profiles[key].name === userProfile.value.name);
                    
                    const updatedMembers = teamMembers.value.map(member => {
                        if (member.id === userId.value) {
                            return { ...member, profile: profileName };
                        }
                        return member;
                    });
                    await saveState({ members: updatedMembers });
                };

                const goToCeoVoting = () => {
                    saveState({ currentStep: 2 });
                }
                
                const submitCeoVote = () => {
                    if(!votedForCEO.value) return;
                    const updatePath = `suggestions.ceoVotes.${userId.value}`;
                    saveState({ [updatePath]: votedForCEO.value });
                }

                const calculateCeoVoteResult = async () => {
                    const docRef = doc(db, "apps", appId, "teams", teamId.value);
                    const currentTeamDoc = await getDoc(docRef);
                    // Preven√ß√£o de race condition: s√≥ executa se o passo atual ainda for a vota√ß√£o.
                    if (currentTeamDoc.data().currentStep !== 2) {
                        return; 
                    }

                    const votes = suggestions.value.ceoVotes;
                    const voteCounts = Object.values(votes).reduce((acc, id) => {
                        acc[id] = (acc[id] || 0) + 1;
                        return acc;
                    }, {});

                    const sortedVotes = Object.entries(voteCounts).sort(([,a],[,b]) => b-a);
                    const electedCeoId = sortedVotes[0][0];

                    let scoreUpdate = 0;
                    const ceoProfile = teamMembers.value.find(m => m.id === electedCeoId)?.profile;
                    const profileScores = { 'Comunicador': 25, 'Inovador': 20, 'Executor': 15, 'Analista': 10 };
                    scoreUpdate += profileScores[ceoProfile] || 0;
                    
                    const topVoteCount = sortedVotes[0][1];
                    if (topVoteCount === teamMembers.value.length) {
                        scoreUpdate += 20; // Unanime
                    } else if (topVoteCount / teamMembers.value.length > 0.66) {
                        scoreUpdate += 10; // Maioria
                    } else {
                        scoreUpdate -= 15; // Dividido
                    }
                    
                    const currentScore = currentTeamDoc.data().score || 0;

                    const newRoles = { 'CEO': electedCeoId };
                    
                    await saveState({
                        currentStep: 3,
                        assignedRoles: newRoles,
                        score: currentScore + scoreUpdate
                    });
                };

                const getCeoName = () => {
                    const ceoId = assignedRoles.value['CEO'];
                    return teamMembers.value.find(m => m.id === ceoId)?.name || '...';
                }

                const confirmRoles = async () => {
                    await saveState({ currentStep: 3.5 });
                };
                
                const goToCompanyChoice = () => {
                    saveState({ currentStep: 4 });
                }

                const calculatePoints = () => {
                    let totalScore = 0;
                    const selectedCompanyId = selectedCompanyForSuggestion.value;
                    if(!selectedCompanyId) return 0;
                    
                    const companyProfiles = { 'Fintech': ['Analista', 'Analista', 'Executor'], 'Edtech': ['Inovador', 'Inovador', 'Comunicador'], 'Logtech': ['Executor', 'Executor', 'Analista']};
                    const teamProfiles = teamMembers.value.map(m => m.profile);
                    const targetProfiles = companyProfiles[selectedCompanyId];
                    totalScore += teamProfiles.reduce((score, profile) => targetProfiles.includes(profile) ? score + 15 : score + 5, 0);

                    const roleAffinities = { 'CEO': { 'Comunicador': 20, 'Inovador': 15, 'Executor': 10, 'Analista': 5 }, 'CTO': { 'Inovador': 20, 'Analista': 15, 'Executor': 10, 'Comunicador': 5 }, 'COO': { 'Executor': 20, 'Analista': 15, 'Comunicador': 10, 'Inovador': 5 }, 'CFO': { 'Analista': 20, 'Executor': 15, 'Comunicador': 5, 'Inovador': 5 }, 'CMO': { 'Comunicador': 20, 'Inovador': 15, 'Executor': 5, 'Analista': 5 }};
                    for (const roleId in assignedRoles.value) {
                        const memberId = assignedRoles.value[roleId];
                        const member = teamMembers.value.find(m => m.id === memberId);
                        if (member && member.profile && roleAffinities[roleId]) {
                            totalScore += roleAffinities[roleId][member.profile] || 0;
                        }
                    }

                    const hirePriorities = {
                       'Fintech': { 'Desenvolvedor S√™nior': 20, 'Analista de Qualidade (QA)': 20, 'Cientista de Dados': 15, 'Engenheiro de DevOps': 10, 'Designer UX/UI': 10, 'Desenvolvedor J√∫nior': 5, 'Especialista de Suporte': 5, 'Gerente de Projetos': 0, 'Social Media': 0, 'Vendedor (SDR)': 0 },
                       'Edtech': { 'Designer UX/UI': 20, 'Desenvolvedor S√™nior': 15, 'Social Media': 15, 'Especialista de Suporte': 15, 'Desenvolvedor J√∫nior': 10, 'Analista de Qualidade (QA)': 5, 'Cientista de Dados': 5, 'Gerente de Projetos': 0, 'Engenheiro de DevOps': 0, 'Vendedor (SDR)': 0},
                       'Logtech': { 'Gerente de Projetos': 20, 'Engenheiro de DevOps': 20, 'Vendedor (SDR)': 15, 'Desenvolvedor S√™nior': 10, 'Especialista de Suporte': 10, 'Analista de Qualidade (QA)': 5, 'Desenvolvedor J√∫nior': 5, 'Cientista de Dados': 0, 'Designer UX/UI': 0, 'Social Media': 0 }
                    };

                    for(const hireRole in hiredCounts.value) {
                        const count = hiredCounts.value[hireRole]?.count || 0;
                        if (count > 0 && hirePriorities[selectedCompanyId]) {
                            totalScore += (hirePriorities[selectedCompanyId][hireRole] || 0) * count;
                        }
                    }

                    return totalScore;
                };
                
                const submitCompanySuggestion = () => {
                    const suggestion = selectedCompanyForSuggestion.value;
                    if(!suggestion) return;
                    
                    const currentUser = teamMembers.value.find(m => m.id === userId.value);
                    const updatePath = `suggestions.company.${userId.value}`;
                    saveState({ [updatePath]: { name: currentUser.name, suggestion: suggestion } });
                    userSuggestion.value.company = true;
                };

                const getSuggestionsFor = (type, choice) => {
                    if (!suggestions.value || !suggestions.value[type]) return [];
                    return Object.values(suggestions.value[type])
                        .filter(s => s.suggestion === choice)
                        .map(s => s.name);
                };

                const confirmCompanyChoice = async () => {
                    const docRef = doc(db, "apps", appId, "teams", teamId.value);
                    const currentTeamDoc = await getDoc(docRef);
                    const currentScore = currentTeamDoc.data().score || 0;
                    
                    const scoreUpdate = calculatePoints();

                    await saveState({ 
                        selectedCompany: selectedCompanyForSuggestion.value, 
                        currentStep: 5,
                        score: scoreUpdate // A pontua√ß√£o de contrata√ß√£o ser√° adicionada depois
                    });
                };

                const isMemberAssigned = (memberId, currentRole) => {
                    const assignedElsewhere = Object.entries(assignedRoles.value).some(([role, id]) => id === memberId && role !== currentRole);
                    return assignedElsewhere;
                };
                
                const updateRoles = () => {
                    saveState({ assignedRoles: assignedRoles.value });
                };
                
                const getSelectedCompanyName = () => companies.find(c => c.id === selectedCompanyForSuggestion.value)?.name || 'sua empresa';

                const getCompanyMarketInfo = () => {
                    const infos = {
                        'Fintech': 'O mercado de Fintech √© baseado em <strong>CONFIAN√áA</strong>. Seus clientes confiam em voc√™ com o dinheiro deles. Falhas de seguran√ßa ou bugs que causem perdas financeiras s√£o fatais. Al√©m disso, a competi√ß√£o √© acirrada. Para se destacar, voc√™ precisa entender o comportamento financeiro dos seus usu√°rios para oferecer produtos personalizados. Pense em: Qualidade impec√°vel, an√°lise de dados e uma base de engenharia robusta.',
                        'Edtech': 'O desafio da Edtech √© a <strong>RETEN√á√ÉO</strong>. √â f√°cil baixar um app educativo, mas dif√≠cil manter o aluno engajado. Sua plataforma precisa ser visualmente atraente, intuitiva e, acima de tudo, divertida. A cria√ß√£o de uma comunidade forte nas redes sociais e um suporte atencioso aos pais e alunos pode ser um grande diferencial. Pense em: Experi√™ncia do usu√°rio (UX), engajamento comunit√°rio e suporte ao cliente.',
                        'Logtech': 'O mundo da Logtech √© sobre <strong>EFICI√äNCIA</strong>. Seus clientes s√£o outras empresas (B2B) que querem economizar tempo e dinheiro. Eles n√£o se importam com um design super inovador, mas sim com um sistema que seja est√°vel, r√°pido e que entregue o resultado prometido. Para conseguir esses clientes, √© preciso uma abordagem de vendas direta e proativa. Pense em: Estabilidade da infraestrutura, gest√£o de projetos e vendas diretas.'
                    };
                    return infos[selectedCompanyForSuggestion.value] || '';
                }

                const getHireCount = (role) => hiredCounts.value[role]?.count || 0;

                const adjustHireCount = (hire, amount) => {
                    if (!hiredCounts.value[hire.role]) {
                        hiredCounts.value[hire.role] = { count: 0, salario: hire.salario };
                    }
                    const newCount = hiredCounts.value[hire.role].count + amount;
                    if (newCount >= 0) {
                        hiredCounts.value[hire.role].count = newCount;
                    }
                };

                const submitHiresSuggestion = () => {
                    if (saldoRestanteMensal.value < 0) return;
                    const currentUser = teamMembers.value.find(m => m.id === userId.value);
                    const updatePath = `suggestions.hires.${userId.value}`;
                    saveState({ [updatePath]: { 
                        memberName: currentUser.name,
                        hires: hiredCounts.value,
                        totalCost: orcamentoInicial.value - saldoRestanteMensal.value
                    } });
                    userSuggestion.value.hires = true;
                };

                const confirmHires = async () => {
                    const docRef = doc(db, "apps", appId, "teams", teamId.value);
                    const currentTeamDoc = await getDoc(docRef);
                    const currentScore = currentTeamDoc.data().score || 0;

                    const finalScore = calculatePoints();

                    await saveState({
                        currentStep: 6,
                        hiredCounts: hiredCounts.value, 
                        score: finalScore
                    });
                };
                
                const getRoleHolderName = (roleId) => {
                    const memberId = assignedRoles.value[roleId];
                    return teamMembers.value.find(m => m.id === memberId)?.name || 'N√£o definido';
                }

                const getRoleColor = (roleId) => {
                    const colors = { 'CTO': 'bg-teal-500', 'COO': 'bg-blue-500', 'CFO': 'bg-green-500', 'CMO': 'bg-purple-500' };
                    return colors[roleId] || 'bg-gray-500';
                }
                
                const getHiresForRole = (roleId) => {
                    return availableHires.filter(h => h.area === roleId && getHireCount(h.role) > 0);
                }

                const downloadOrganogram = () => {
                    const node = document.getElementById('organogram-container');
                     html2canvas(node, {
                        backgroundColor: '#ffffff',
                        scale: 2
                    }).then(canvas => {
                        const image = canvas.toDataURL("image/png").replace("image/png", "image/octet-stream");
                        const link = document.createElement('a');
                        link.download = `organograma-${teamName.value}.png`;
                        link.href = image;
                        link.click();
                    });
                };
                
                const enterProfessorMode = () => {
                    if (professorPassword.value === "mestre") {
                        isProfessor.value = true;
                    } else {
                        alert("Senha incorreta.");
                    }
                     professorPassword.value = '';
                };

                const logoutProfessor = () => {
                    isProfessor.value = false;
                }

                const toggleScoresVisibility = async () => {
                    try {
                        const docRef = doc(db, "apps", appId, "controller", "game_state");
                        await setDoc(docRef, { scoresVisible: !scoresVisible.value }, { merge: true });
                    } catch(error) {
                        console.error("Error toggling score visibility:", error);
                        alert("N√£o foi poss√≠vel alterar a visibilidade. Verifique a conex√£o.");
                    }
                };
                
                const confirmResetGame = () => {
                    if (confirm("TEM CERTEZA? Isso ir√° apagar TODAS as equipes e reiniciar o jogo para todos os alunos. Esta a√ß√£o n√£o pode ser desfeita.")) {
                        resetGame();
                    }
                };

                const resetGame = async () => {
                    loadingMessage.value = "Reiniciando o jogo para todos...";
                    showProfessorModal.value = false;
                    loading.value = true;

                    try {
                        const teamsRef = collection(db, "apps", appId, "teams");
                        const teamSnapshot = await getDocs(teamsRef);
                        const deletePromises = teamSnapshot.docs.map(d => deleteDoc(d.ref));
                        await Promise.all(deletePromises);

                        const controllerRef = doc(db, "apps", appId, "controller", "game_state");
                        await setDoc(controllerRef, { scoresVisible: false });

                        alert("Jogo reiniciado com sucesso! Os alunos ser√£o enviados para a tela inicial.");
                        resetLocalState();
                        loading.value = false;

                    } catch (error) {
                        console.error("Erro ao zerar o jogo:", error);
                        alert("Ocorreu um erro ao zerar o jogo.");
                        loading.value = false;
                    }
                };

                onMounted(() => {
                    setupFirebase();
                });

                return {
                    loading, loadingMessage, connected, connectionMessage, currentStep, teamName, teamNameInput, joinCodeInput, joinCodeDisplay,
                    questions, answers, userProfile,
                    companies, selectedCompanyForSuggestion,
                    allRoles, availableRoles, otherRoles, assignedRoles, teamMembers, isMemberAssigned, areAllRolesAssigned, updateRoles, confirmRoles,
                    orcamentoInicial, availableHires, hiredCounts, saldoRestanteMensal, getSelectedCompanyName, getCompanyMarketInfo, getHireCount, adjustHireCount,
                    getRoleHolderName, downloadOrganogram, getRoleColor, getHiresForRole,
                    createTeam, joinTeam,
                    showScoreboard, sortedTeams, teamId, scoresVisible,
                    showProfessorModal, isProfessor, professorPassword, enterProfessorMode, logoutProfessor, toggleScoresVisibility, confirmResetGame,
                    currentUserProfileCompleted, calculateProfile, confirmProfile, formatCurrency,
                    isCEO, submitCompanySuggestion, confirmCompanyChoice, getSuggestionsFor, suggestions, userSuggestion,
                    submitHiresSuggestion, confirmHires,
                    isLoggedIn, playerNameInput, playerPasswordInput,
                    goToCeoVoting, isTeamCreator, allMembersHaveProfile, submitCeoVote, votedForCEO, userVotedForCEO, getCeoName, goToCompanyChoice
                }
            }
        }).mount('#app')

    </script>
</body>
</html>

